<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Program Listing for File CUDASimulation.cu &mdash; FLAME GPU 2 0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/flamegpu.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=e43216b9"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
        <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #4d4d4d" >

          
          
          <a href="../index.html" class="icon icon-home">
            FLAME GPU 2
              <img src="../_static/flamegpu2-icon-notext-128.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/index.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/index.html#c">C++</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#creating-a-new-project">Creating a New Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#compiling-your-project">Compiling Your Project</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/index.html#cmake-gui-windows-only">CMake GUI (Windows Only)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#running-your-project">Running Your Project</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/index.html#python-3">Python 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#q-python-installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#building-from-source">Building From Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#id3">Creating a New Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/index.html#id4">Running your project</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../guide/creating-a-model/index.html">Creating a Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/creating-a-model/index.html#what-is-a-model">What is a Model?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/creating-a-model/index.html#creating-a-modeldescription-object">Creating a ModelDescription Object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/creating-a-model/index.html#supported-types">Supported Types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/environment/index.html">Environmental Properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/environment/index.html#accessing-the-environmentdescription-object">Accessing the EnvironmentDescription Object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/environment/index.html#defining-properties">Defining Properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/environment/index.html#defining-macro-properties">Defining Macro Properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/environment/index.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/defining-agents/index.html">Defining Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-agents/index.html#defining-a-new-agent-type">Defining a New Agent Type</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-agents/index.html#agent-variables">Agent Variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-agents/index.html#agent-id">Agent ID</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-agents/index.html#user-defined-variables">User Defined Variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-agents/index.html#agent-states">Agent States</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-agents/index.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/defining-messages-communication/index.html">Defining Messages (Communication)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-messages-communication/index.html#communication-strategies">Communication Strategies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-messages-communication/index.html#defining-a-new-message-type">Defining a New Message Type</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-messages-communication/index.html#brute-force-specialisation">Brute Force Specialisation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-messages-communication/index.html#bucket-specialisation">Bucket Specialisation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-messages-communication/index.html#spatial-specialisation">Spatial Specialisation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-messages-communication/index.html#array-specialisation">Array Specialisation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-messages-communication/index.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/agent-functions/index.html">Agent Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/defining-agent-functions.html">Defining Agent Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/defining-agent-functions.html#c-compile-time-agent-functions">C++ Compile Time Agent Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/defining-agent-functions.html#c-and-python-runtime-compiled-agent-functions">C++ and Python Runtime Compiled Agent Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/defining-agent-functions.html#flame-gpu-python-agent-functions">FLAME GPU Python Agent Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/defining-agent-functions.html#flame-gpu-device-functions">FLAME GPU Device Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/defining-agent-functions.html#flame-gpu-host-device-functions">FLAME GPU Host Device Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/defining-agent-functions.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/modifying-agent-variables.html">Accessing Agent Variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/modifying-agent-variables.html#reading-an-agent-s-id">Reading an Agent’s ID</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/modifying-agent-variables.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/interacting-with-environment.html">Accessing the Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/interacting-with-environment.html#environment-properties">Environment Properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/interacting-with-environment.html#environment-macro-properties">Environment Macro Properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/interacting-with-environment.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/agent-communication.html">Agent Communication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/agent-communication.html#sending-messages">Sending Messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/agent-communication.html#reading-messages">Reading Messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/agent-communication.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/agent-birth-death.html">Agent Birth &amp; Death</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/agent-birth-death.html#agent-death">Agent Death</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/agent-birth-death.html#agent-birth">Agent Birth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/agent-birth-death.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/random-numbers.html">Random Numbers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/random-numbers.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/conditional-behaviours.html">Agent Function Conditions (Conditional Behaviours)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/conditional-behaviours.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/agent-functions/miscellaneous.html">Miscellaneous Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/agent-functions/miscellaneous.html#related-links">Related Links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/host-functions/index.html">Host Functions &amp; Conditions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/host-functions/defining-host-functions.html">Defining Host Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/defining-host-functions.html#types-of-host-function">Types of Host Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/defining-host-functions.html#adding-host-functions-to-a-model">Adding Host Functions to a Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/defining-host-functions.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/host-functions/interacting-with-environment.html">Accessing the Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/interacting-with-environment.html#environment-properties">Environment Properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/interacting-with-environment.html#environment-macro-properties">Environment Macro Properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/interacting-with-environment.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/host-functions/agent-operations.html">Agent Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/agent-operations.html#variable-reductions">Variable Reductions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/agent-operations.html#sorting-agents">Sorting Agents</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/agent-operations.html#agent-creation">Agent Creation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/agent-operations.html#direct-agent-access">Direct Agent Access</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/agent-operations.html#miscellaneous-methods">Miscellaneous Methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/agent-operations.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/host-functions/random-numbers.html">Random Numbers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/random-numbers.html#seeding-the-random-state">Seeding the Random State</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/random-numbers.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/host-functions/miscellaneous.html">Miscellaneous Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/host-functions/miscellaneous.html#related-links">Related Links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/defining-execution-order/index.html">Defining Execution Order</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html">Dependency Graph</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html#specifying-dependencies">Specifying Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html#specifying-roots">Specifying Roots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html#host-layer-functions">Host Layer Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html#generating-layers">Generating Layers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html#visualising-the-dependencies">Visualising the Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html#accessing-the-dependencygraph">Accessing the DependencyGraph</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/dependency-graph.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-execution-order/layers.html">Layers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/layers.html#manual-layer-specification">Manual Layer Specification</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/layers.html#layer-specification-rules">Layer Specification Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/layers.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-execution-order/exit-conditions.html">Exit Conditions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/exit-conditions.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/defining-execution-order/submodels.html">Submodels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/submodels.html#id1">Defining a Submodel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/defining-execution-order/submodels.html#related-links">Related Links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/running-a-simulation/index.html">Running a Simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-a-simulation/configuring-execution.html">Configuring Execution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/configuring-execution.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-a-simulation/initial-state.html">Overriding the Initial State</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/initial-state.html#with-code">With Code</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/initial-state.html#from-file">From File</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/initial-state.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-a-simulation/collecting-data.html">Collecting Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/collecting-data.html#logging">Logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/collecting-data.html#accessing-the-complete-agent-state">Accessing the Complete Agent State</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/collecting-data.html#additional-notes">Additional Notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/running-a-simulation/collecting-data.html#related-links">Related Links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/running-multiple-simulations/index.html">Running Multiple Simulations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-multiple-simulations/index.html#creating-a-cudaensemble">Creating a CUDAEnsemble</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-multiple-simulations/index.html#creating-a-runplanvector">Creating a RunPlanVector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-multiple-simulations/index.html#creating-a-logging-configuration">Creating a Logging Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-multiple-simulations/index.html#configuring-running-the-ensemble">Configuring &amp; Running the Ensemble</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-multiple-simulations/index.html#error-handling-within-ensembles">Error Handling Within Ensembles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/running-multiple-simulations/index.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/visualisation/index.html">Visualisation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/visualisation/building-with-vis.html">Enabling Visualisation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/building-with-vis.html#detecting-visualisation-support">Detecting Visualisation Support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/visualisation/setting-up-vis.html">Configuring a Visualisation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/setting-up-vis.html#visualisation-options">Visualisation Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/setting-up-vis.html#visualising-after-simulation-exit">Visualising After Simulation Exit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/setting-up-vis.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/visualisation/visualising-agents.html">Visualising Agents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/visualising-agents.html#agent-model">Agent Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/visualising-agents.html#agent-position">Agent Position</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/visualising-agents.html#agent-direction">Agent Direction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/visualising-agents.html#agent-scale">Agent Scale</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/visualising-agents.html#agent-color">Agent Color</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/visualising-agents.html#agent-states">Agent States</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/visualising-agents.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/visualisation/adding-details.html">Visualising Additional Details</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/adding-details.html#user-interface-environment-properties">User Interface (Environment Properties)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/adding-details.html#lines">Lines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/adding-details.html#models">Models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/visualisation/adding-details.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/visualisation/visualisation-controls.html">Visualisation Controls</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/debugging-models/index.html">Debugging Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/debugging-models/seatbelts.html">What is FLAMEGPU_SEATBELTS?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/seatbelts.html#enabling-disabling-flamegpu-seatbelts">Enabling/Disabling FLAMEGPU_SEATBELTS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/seatbelts.html#understanding-flamegpu-seatbelts-exceptions">Understanding FLAMEGPU_SEATBELTS Exceptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/seatbelts.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/debugging-models/print.html">Using Print Statements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/print.html#printing-from-agent-functions">Printing From Agent Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/debugging-models/logging.html">Logging Timeseries Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/logging.html#environment-macro-property-counters">Environment Macro Property Counters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/logging.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/debugging-models/using-a-debugger.html">Using a Debugger</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/using-a-debugger.html#windows">Windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/using-a-debugger.html#linux">Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/debugging-models/using-a-debugger.html#related-links">Related Links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/performance-troubleshooting/index.html">Performance Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guide/flamegpu2-source/index.html">Building or Modifying the FLAME GPU 2 Source</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/flamegpu2-source/build-from-source.html">Building FLAME GPU from Source</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/flamegpu2-source/build-from-source.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../guide/flamegpu2-source/request-a-new-feature.html">Requesting Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/flamegpu2-source/contribute.html">Contributing to FLAMEGPU2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../guide/flamegpu2-source/contribute.html#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/flamegpu2-source/contribute.html#submitting-pull-requests">Submitting Pull Requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="../guide/flamegpu2-source/contribute.html#license">License</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guide/telemetry/index.html">Telemetry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../guide/telemetry/index.html#when-is-data-sent">When is Data sent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/telemetry/index.html#where-and-how-is-data-sent">Where and How is Data Sent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/telemetry/index.html#what-data-is-sent">What Data is Sent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/telemetry/index.html#disabling-telemetry-opt-out">Disabling Telemetry (Opt-out)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/telemetry/index.html#developer-notes">Developer Notes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Library API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="library_root.html#page-hierarchy">Page Hierarchy</a></li>
<li class="toctree-l2"><a class="reference internal" href="library_root.html#full-api">Full API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="library_root.html#namespaces">Namespaces</a><ul>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu.html">Namespace flamegpu</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__%40205.html">Namespace flamegpu::&#64;205</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail.html">Namespace flamegpu::detail</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail__%40154.html">Namespace flamegpu::detail::&#64;154</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail__compute_capability.html">Namespace flamegpu::detail::compute_capability</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail__cuda.html">Namespace flamegpu::detail::cuda</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail__curve.html">Namespace flamegpu::detail::curve</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail__cxxname.html">Namespace flamegpu::detail::cxxname</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail__StaticAssert.html">Namespace flamegpu::detail::StaticAssert</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__detail__wddm.html">Namespace flamegpu::detail::wddm</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__exception.html">Namespace flamegpu::exception</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__io.html">Namespace flamegpu::io</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__io__%40162.html">Namespace flamegpu::io::&#64;162</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__util.html">Namespace flamegpu::util</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__util__nvtx.html">Namespace flamegpu::util::nvtx</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__visualiser.html">Namespace flamegpu::visualiser</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__visualiser__Stock.html">Namespace flamegpu::visualiser::Stock</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__visualiser__Stock__Colors.html">Namespace flamegpu::visualiser::Stock::Colors</a></li>
<li class="toctree-l4"><a class="reference internal" href="namespace_flamegpu__visualiser__Stock__Palettes.html">Namespace flamegpu::visualiser::Stock::Palettes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="library_root.html#classes-and-structs">Classes and Structs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1AgentData.html">Struct AgentData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1AgentFunctionData.html">Struct AgentFunctionData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1AgentLogFrame.html">Struct AgentLogFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1CUDAEnsemble_1_1EnsembleConfig.html">Struct CUDAEnsemble::EnsembleConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1CUDASimulation_1_1Config.html">Struct CUDASimulation::Config</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1CUDASimulation_1_1Singletons.html">Struct CUDASimulation::Singletons</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1AgentVariable.html">Struct AgentVariable</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1AgentVariableHash.html">Struct AgentVariableHash</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1Any.html">Struct Any</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAFatAgent_1_1AgentState.html">Struct CUDAFatAgent::AgentState</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAFatAgent_1_1AgentState__hash.html">Struct CUDAFatAgent::AgentState_hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAFatAgent_1_1NewBuffer.html">Struct CUDAFatAgent::NewBuffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAMacroEnvironment_1_1MacroEnvProp.html">Struct CUDAMacroEnvironment::MacroEnvProp</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAScanCompactionConfig.html">Struct CUDAScanCompactionConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAScanCompactionPtrs.html">Struct CUDAScanCompactionPtrs</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAScatter_1_1InversionIterator.html">Struct CUDAScatter::InversionIterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAScatter_1_1ScatterData.html">Struct CUDAScatter::ScatterData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1CUDAScatter_1_1StreamData.html">Struct CUDAScatter::StreamData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1curve_1_1CurveRTCHost_1_1RTCEnvMacroPropertyProperties.html">Struct CurveRTCHost::RTCEnvMacroPropertyProperties</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1curve_1_1CurveRTCHost_1_1RTCEnvVariableProperties.html">Struct CurveRTCHost::RTCEnvVariableProperties</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1curve_1_1CurveRTCHost_1_1RTCVariableProperties.html">Struct CurveRTCHost::RTCVariableProperties</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1curve_1_1CurveStringHash.html">Template Struct CurveStringHash</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1curve_1_1CurveStringHash_3_01N_00_011_01_4.html">Template Struct CurveStringHash&lt; N, 1 &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1curve_1_1CurveTable.html">Struct CurveTable</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1Dims.html">Template Struct Dims</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1EnvironmentManager_1_1DefragProp.html">Struct EnvironmentManager::DefragProp</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1EnvironmentManager_1_1EnvProp.html">Struct EnvironmentManager::EnvProp</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1EnvironmentManager_1_1MappedProp.html">Struct EnvironmentManager::MappedProp</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1JitifyCache_1_1CachedProgram.html">Struct JitifyCache::CachedProgram</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1SharedBlock.html">Struct SharedBlock</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1SimRunner_1_1ErrorDetail.html">Struct SimRunner::ErrorDetail</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1standard__deviation__add__impl.html">Struct standard_deviation_add_impl</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1standard__deviation__add__impl_1_1binary__function.html">Template Struct standard_deviation_add_impl::binary_function</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1standard__deviation__subtract__mean__impl.html">Struct standard_deviation_subtract_mean_impl</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1standard__deviation__subtract__mean__impl_1_1unary__function.html">Template Struct standard_deviation_subtract_mean_impl::unary_function</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1StaticAssert_1_1__Cat__base.html">Template Struct _Cat_base</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1StaticAssert_1_1__Is__IntType.html">Template Struct _Is_IntType</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1StaticAssert_1_1__Is__RealType.html">Template Struct _Is_RealType</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1StaticAssert_1_1integral__constant.html">Template Struct integral_constant</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1StaticAssert_1_1is__same.html">Template Struct is_same</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1StaticAssert_1_1is__same_3_01__Ty1_00_01__Ty1_01_4.html">Template Struct is_same&lt; _Ty1, _Ty1 &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1type__decode.html">Template Struct type_decode</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1detail_1_1VariableBuffer.html">Struct VariableBuffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1DeviceAgentVector__impl_1_1VariableBufferPair.html">Struct DeviceAgentVector_impl::VariableBufferPair</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1EnvironmentData.html">Struct EnvironmentData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1EnvironmentData_1_1MacroPropData.html">Struct EnvironmentData::MacroPropData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1EnvironmentData_1_1PropData.html">Struct EnvironmentData::PropData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1exception_1_1DeviceExceptionBuffer.html">Struct DeviceExceptionBuffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1ExitLogFrame.html">Struct ExitLogFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1HostMacroProperty__MetaData.html">Struct HostMacroProperty_MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1LayerData.html">Struct LayerData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1LogFrame.html">Struct LogFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1LoggingConfig_1_1NameReductionFn.html">Struct LoggingConfig::NameReductionFn</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageArray2D_1_1Data.html">Struct MessageArray2D::Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageArray2D_1_1MetaData.html">Struct MessageArray2D::MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageArray3D_1_1Data.html">Struct MessageArray3D::Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageArray3D_1_1MetaData.html">Struct MessageArray3D::MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageArray_1_1Data.html">Struct MessageArray::Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageArray_1_1MetaData.html">Struct MessageArray::MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageBruteForce_1_1Data.html">Struct MessageBruteForce::Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageBruteForce_1_1MetaData.html">Struct MessageBruteForce::MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageBucket_1_1Data.html">Struct MessageBucket::Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageBucket_1_1MetaData.html">Struct MessageBucket::MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageSpatial2D_1_1Data.html">Struct MessageSpatial2D::Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageSpatial2D_1_1GridPos2D.html">Struct MessageSpatial2D::GridPos2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageSpatial2D_1_1MetaData.html">Struct MessageSpatial2D::MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageSpatial3D_1_1Data.html">Struct MessageSpatial3D::Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageSpatial3D_1_1GridPos3D.html">Struct MessageSpatial3D::GridPos3D</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1MessageSpatial3D_1_1MetaData.html">Struct MessageSpatial3D::MetaData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1ModelData.html">Struct ModelData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1NewAgentStorage.html">Struct NewAgentStorage</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1RunLog.html">Struct RunLog</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1RunLog_1_1PerformanceSpecs.html">Struct RunLog::PerformanceSpecs</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1Simulation_1_1Config.html">Struct Simulation::Config</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1StepLogFrame.html">Struct StepLogFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1SubAgentData.html">Struct SubAgentData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1SubEnvironmentData.html">Struct SubEnvironmentData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1SubModelData.html">Struct SubModelData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t.html">Template Struct sum_input_t</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01char_01_4.html">Template Struct sum_input_t&lt; char &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01double_01_4.html">Template Struct sum_input_t&lt; double &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01float_01_4.html">Template Struct sum_input_t&lt; float &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01int16__t_01_4.html">Template Struct sum_input_t&lt; int16_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01int32__t_01_4.html">Template Struct sum_input_t&lt; int32_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01int64__t_01_4.html">Template Struct sum_input_t&lt; int64_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01int8__t_01_4.html">Template Struct sum_input_t&lt; int8_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01uint16__t_01_4.html">Template Struct sum_input_t&lt; uint16_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01uint32__t_01_4.html">Template Struct sum_input_t&lt; uint32_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01uint64__t_01_4.html">Template Struct sum_input_t&lt; uint64_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1sum__input__t_3_01uint8__t_01_4.html">Template Struct sum_input_t&lt; uint8_t &gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1util_1_1StringPairHash.html">Struct StringPairHash</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1Variable.html">Struct Variable</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1VarOffsetStruct.html">Struct VarOffsetStruct</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1VarOffsetStruct_1_1OffsetLen.html">Struct VarOffsetStruct::OffsetLen</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1AgentStateVisData.html">Struct AgentStateVisData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1AgentVisData.html">Struct AgentVisData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Color.html">Struct Color</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1ModelVisData.html">Struct ModelVisData</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Palette.html">Struct Palette</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1Dark2.html">Struct Dark2</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1Greys.html">Struct Greys</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1Pastel.html">Struct Pastel</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1PiYG.html">Struct PiYG</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1RdYlBu.html">Struct RdYlBu</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1Set1.html">Struct Set1</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1Set2.html">Struct Set2</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1Viridis.html">Struct Viridis</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1YlGn.html">Struct YlGn</a></li>
<li class="toctree-l4"><a class="reference internal" href="structflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1_1YlOrRd.html">Struct YlOrRd</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentDescription.html">Class AgentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentFunctionDescription.html">Class AgentFunctionDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentInstance.html">Class AgentInstance</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentLoggingConfig.html">Class AgentLoggingConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentRandom.html">Class AgentRandom</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentVector.html">Class AgentVector</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentVector_1_1const__iterator.html">Class AgentVector::const_iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentVector_1_1const__reverse__iterator.html">Class AgentVector::const_reverse_iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentVector_1_1iterator.html">Class AgentVector::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentVector_1_1reverse__iterator.html">Class AgentVector::reverse_iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentVector__Agent.html">Class AgentVector_Agent</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1AgentVector__CAgent.html">Class AgentVector_CAgent</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CAgentDescription.html">Class CAgentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CAgentFunctionDescription.html">Class CAgentFunctionDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CEnvironmentDescription.html">Class CEnvironmentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CLayerDescription.html">Class CLayerDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CSubAgentDescription.html">Class CSubAgentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CSubEnvironmentDescription.html">Class CSubEnvironmentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CSubModelDescription.html">Class CSubModelDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CUDAEnsemble.html">Class CUDAEnsemble</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1CUDASimulation.html">Class CUDASimulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1DependencyGraph.html">Class DependencyGraph</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1DependencyNode.html">Class DependencyNode</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1AgentInterface.html">Class AgentInterface</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CubTemporaryMemory.html">Class CubTemporaryMemory</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAAgent.html">Class CUDAAgent</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAAgentStateList.html">Class CUDAAgentStateList</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAEventTimer.html">Class CUDAEventTimer</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAFatAgent.html">Class CUDAFatAgent</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAFatAgentStateList.html">Class CUDAFatAgentStateList</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAMacroEnvironment.html">Class CUDAMacroEnvironment</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAMessage.html">Class CUDAMessage</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAMessageList.html">Class CUDAMessageList</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAScanCompaction.html">Class CUDAScanCompaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1CUDAScatter.html">Class CUDAScatter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1curve_1_1Curve.html">Class Curve</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1curve_1_1CurveRTCHost.html">Class CurveRTCHost</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1curve_1_1DeviceCurve.html">Class DeviceCurve</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1curve_1_1HostCurve.html">Class HostCurve</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1EnvironmentManager.html">Class EnvironmentManager</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1GenericMemoryVector.html">Class GenericMemoryVector</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1JitifyCache.html">Class JitifyCache</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1MemoryVector.html">Template Class MemoryVector</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1RandomManager.html">Class RandomManager</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1SignalHandlers.html">Class SignalHandlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1SimLogger.html">Class SimLogger</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1SimRunner.html">Class SimRunner</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1SteadyClockTimer.html">Class SteadyClockTimer</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1TestSuiteTelemetry.html">Class TestSuiteTelemetry</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1detail_1_1Timer.html">Class Timer</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1DeviceAgentVector__impl.html">Class DeviceAgentVector_impl</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1DeviceAPI.html">Template Class DeviceAPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1DeviceAPI_1_1AgentOut.html">Class DeviceAPI::AgentOut</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1DeviceEnvironment.html">Class DeviceEnvironment</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1DeviceMacroProperty.html">Template Class DeviceMacroProperty</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1EnvironmentDescription.html">Class EnvironmentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1AgentIDCollision.html">Class AgentIDCollision</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1ArrayMessageWriteConflict.html">Class ArrayMessageWriteConflict</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1CUDAError.html">Class CUDAError</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1CurveException.html">Class CurveException</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1DeviceError.html">Class DeviceError</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1DeviceExceptionManager.html">Class DeviceExceptionManager</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1DifferentModel.html">Class DifferentModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1DuplicateEnvProperty.html">Class DuplicateEnvProperty</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1EnsembleError.html">Class EnsembleError</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1EnvDescriptionAlreadyLoaded.html">Class EnvDescriptionAlreadyLoaded</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1ExpiredWeakPtr.html">Class ExpiredWeakPtr</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1FileAlreadyExists.html">Class FileAlreadyExists</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1FLAMEGPUException.html">Class FLAMEGPUException</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidAgent.html">Class InvalidAgent</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidAgentFunc.html">Class InvalidAgentFunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidAgentName.html">Class InvalidAgentName</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidAgentState.html">Class InvalidAgentState</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidAgentVar.html">Class InvalidAgentVar</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidArgument.html">Class InvalidArgument</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidCudaAgent.html">Class InvalidCudaAgent</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidCudaAgentDesc.html">Class InvalidCudaAgentDesc</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidCudaAgentMapSize.html">Class InvalidCudaAgentMapSize</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidCudaAgentState.html">Class InvalidCudaAgentState</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidCUDAComputeCapability.html">Class InvalidCUDAComputeCapability</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidCUDAdevice.html">Class InvalidCUDAdevice</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidCudaMessage.html">Class InvalidCudaMessage</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidDependencyGraph.html">Class InvalidDependencyGraph</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidEnvProperty.html">Class InvalidEnvProperty</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidEnvPropertyType.html">Class InvalidEnvPropertyType</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidFilePath.html">Class InvalidFilePath</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidFuncLayerIndx.html">Class InvalidFuncLayerIndx</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidHostFunc.html">Class InvalidHostFunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidInputFile.html">Class InvalidInputFile</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidLayerMember.html">Class InvalidLayerMember</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidMemoryCapacity.html">Class InvalidMemoryCapacity</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidMessage.html">Class InvalidMessage</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidMessageData.html">Class InvalidMessageData</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidMessageName.html">Class InvalidMessageName</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidMessageType.html">Class InvalidMessageType</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidMessageVar.html">Class InvalidMessageVar</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidOperation.html">Class InvalidOperation</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidParent.html">Class InvalidParent</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidStateName.html">Class InvalidStateName</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidSubAgentName.html">Class InvalidSubAgentName</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidSubModel.html">Class InvalidSubModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidSubModelName.html">Class InvalidSubModelName</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidVarArrayLen.html">Class InvalidVarArrayLen</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1InvalidVarType.html">Class InvalidVarType</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1OutOfBoundsException.html">Class OutOfBoundsException</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1OutOfMemory.html">Class OutOfMemory</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1OutOfRangeVarArray.html">Class OutOfRangeVarArray</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1RapidJSONError.html">Class RapidJSONError</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1ReadOnlyEnvProperty.html">Class ReadOnlyEnvProperty</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1ReservedName.html">Class ReservedName</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1TimerException.html">Class TimerException</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1TinyXMLError.html">Class TinyXMLError</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1UnknownError.html">Class UnknownError</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1UnknownInternalError.html">Class UnknownInternalError</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1UnsupportedFileType.html">Class UnsupportedFileType</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1UnsupportedVarType.html">Class UnsupportedVarType</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1VersionMismatch.html">Class VersionMismatch</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1exception_1_1VisualisationException.html">Class VisualisationException</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostAgentAPI.html">Class HostAgentAPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostAPI.html">Class HostAPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostConditionCallback.html">Class HostConditionCallback</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostEnvironment.html">Class HostEnvironment</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostFunctionCallback.html">Class HostFunctionCallback</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostFunctionDescription.html">Class HostFunctionDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostMacroProperty.html">Template Class HostMacroProperty</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostNewAgentAPI.html">Class HostNewAgentAPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1HostRandom.html">Class HostRandom</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1JSONLogger.html">Class JSONLogger</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1JSONStateReader.html">Class JSONStateReader</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1JSONStateReader__agentsize__counter.html">Class JSONStateReader_agentsize_counter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1JSONStateReader__impl.html">Class JSONStateReader_impl</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1JSONStateWriter.html">Class JSONStateWriter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1Logger.html">Class Logger</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1LoggerFactory.html">Class LoggerFactory</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1StateReader.html">Class StateReader</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1StateReaderFactory.html">Class StateReaderFactory</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1StateWriter.html">Class StateWriter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1StateWriterFactory.html">Class StateWriterFactory</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1Telemetry.html">Class Telemetry</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1XMLLogger.html">Class XMLLogger</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1XMLStateReader.html">Class XMLStateReader</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1io_1_1XMLStateWriter.html">Class XMLStateWriter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1LayerDescription.html">Class LayerDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1LoggingConfig.html">Class LoggingConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray.html">Class MessageArray</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D.html">Class MessageArray2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1CDescription.html">Class MessageArray2D::CDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1CUDAModelHandler.html">Class MessageArray2D::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1Description.html">Class MessageArray2D::Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In.html">Class MessageArray2D::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1Filter.html">Class In::Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1Filter_1_1iterator.html">Class Filter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1Filter_1_1Message.html">Class Filter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1Message.html">Class In::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1VonNeumannFilter.html">Class In::VonNeumannFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1VonNeumannFilter_1_1iterator.html">Class VonNeumannFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1VonNeumannFilter_1_1Message.html">Class VonNeumannFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1VonNeumannWrapFilter.html">Class In::VonNeumannWrapFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1VonNeumannWrapFilter_1_1iterator.html">Class VonNeumannWrapFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1VonNeumannWrapFilter_1_1Message.html">Class VonNeumannWrapFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1WrapFilter.html">Class In::WrapFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1WrapFilter_1_1iterator.html">Class WrapFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1In_1_1WrapFilter_1_1Message.html">Class WrapFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray2D_1_1Out.html">Class MessageArray2D::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D.html">Class MessageArray3D</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1CDescription.html">Class MessageArray3D::CDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1CUDAModelHandler.html">Class MessageArray3D::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1Description.html">Class MessageArray3D::Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In.html">Class MessageArray3D::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1Filter.html">Class In::Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1Filter_1_1iterator.html">Class Filter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1Filter_1_1Message.html">Class Filter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1Message.html">Class In::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1VonNeumannFilter.html">Class In::VonNeumannFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1VonNeumannFilter_1_1iterator.html">Class VonNeumannFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1VonNeumannFilter_1_1Message.html">Class VonNeumannFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1VonNeumannWrapFilter.html">Class In::VonNeumannWrapFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1VonNeumannWrapFilter_1_1iterator.html">Class VonNeumannWrapFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1VonNeumannWrapFilter_1_1Message.html">Class VonNeumannWrapFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1WrapFilter.html">Class In::WrapFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1WrapFilter_1_1iterator.html">Class WrapFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1In_1_1WrapFilter_1_1Message.html">Class WrapFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray3D_1_1Out.html">Class MessageArray3D::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1CDescription.html">Class MessageArray::CDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1CUDAModelHandler.html">Class MessageArray::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1Description.html">Class MessageArray::Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In.html">Class MessageArray::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In_1_1Filter.html">Class In::Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In_1_1Filter_1_1iterator.html">Class Filter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In_1_1Filter_1_1Message.html">Class Filter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In_1_1Message.html">Class In::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In_1_1WrapFilter.html">Class In::WrapFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In_1_1WrapFilter_1_1iterator.html">Class WrapFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1In_1_1WrapFilter_1_1Message.html">Class WrapFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageArray_1_1Out.html">Class MessageArray::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce.html">Class MessageBruteForce</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce_1_1CDescription.html">Class MessageBruteForce::CDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce_1_1CUDAModelHandler.html">Class MessageBruteForce::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce_1_1Description.html">Class MessageBruteForce::Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce_1_1In.html">Class MessageBruteForce::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce_1_1In_1_1iterator.html">Class In::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce_1_1In_1_1Message.html">Class In::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBruteForce_1_1Out.html">Class MessageBruteForce::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket.html">Class MessageBucket</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1CDescription.html">Class MessageBucket::CDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1CUDAModelHandler.html">Class MessageBucket::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1Description.html">Class MessageBucket::Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1In.html">Class MessageBucket::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1In_1_1Filter.html">Class In::Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1In_1_1Filter_1_1iterator.html">Class Filter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1In_1_1Filter_1_1Message.html">Class Filter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageBucket_1_1Out.html">Class MessageBucket::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageNone.html">Class MessageNone</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageNone_1_1CUDAModelHandler.html">Class MessageNone::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageNone_1_1In.html">Class MessageNone::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageNone_1_1Out.html">Class MessageNone::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D.html">Class MessageSpatial2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1CDescription.html">Class MessageSpatial2D::CDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1CUDAModelHandler.html">Class MessageSpatial2D::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1Description.html">Class MessageSpatial2D::Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1In.html">Class MessageSpatial2D::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1In_1_1Filter.html">Class In::Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1In_1_1Filter_1_1iterator.html">Class Filter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1In_1_1Filter_1_1Message.html">Class Filter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1In_1_1WrapFilter.html">Class In::WrapFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1In_1_1WrapFilter_1_1iterator.html">Class WrapFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1In_1_1WrapFilter_1_1Message.html">Class WrapFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial2D_1_1Out.html">Class MessageSpatial2D::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D.html">Class MessageSpatial3D</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1CDescription.html">Class MessageSpatial3D::CDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1CUDAModelHandler.html">Class MessageSpatial3D::CUDAModelHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1Description.html">Class MessageSpatial3D::Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1In.html">Class MessageSpatial3D::In</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1In_1_1Filter.html">Class In::Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1In_1_1Filter_1_1iterator.html">Class Filter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1In_1_1Filter_1_1Message.html">Class Filter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1In_1_1WrapFilter.html">Class In::WrapFilter</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1In_1_1WrapFilter_1_1iterator.html">Class WrapFilter::iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1In_1_1WrapFilter_1_1Message.html">Class WrapFilter::Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpatial3D_1_1Out.html">Class MessageSpatial3D::Out</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1MessageSpecialisationHandler.html">Class MessageSpecialisationHandler</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1ModelDescription.html">Class ModelDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1ReadOnlyDeviceAPI.html">Class ReadOnlyDeviceAPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1ReadOnlyDeviceEnvironment.html">Class ReadOnlyDeviceEnvironment</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1ReadOnlyDeviceMacroProperty.html">Template Class ReadOnlyDeviceMacroProperty</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1RunPlan.html">Class RunPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1RunPlanVector.html">Class RunPlanVector</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1Simulation.html">Class Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1StepLoggingConfig.html">Class StepLoggingConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1SubAgentDescription.html">Class SubAgentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1SubEnvironmentDescription.html">Class SubEnvironmentDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1SubModelDescription.html">Class SubModelDescription</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1util_1_1nvtx_1_1Range.html">Class Range</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1AgentStateVis.html">Class AgentStateVis</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1AgentVis.html">Class AgentVis</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1AutoPalette.html">Class AutoPalette</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1ColorFunction.html">Class ColorFunction</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1DiscreteColor.html">Template Class DiscreteColor</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1HSVInterpolation.html">Class HSVInterpolation</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1LineVis.html">Class LineVis</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1ModelVis.html">Class ModelVis</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1Palette_1_1const__iterator.html">Class Palette::const_iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1PanelVis.html">Class PanelVis</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1StaticColor.html">Class StaticColor</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1StaticModelVis.html">Class StaticModelVis</a></li>
<li class="toctree-l4"><a class="reference internal" href="classflamegpu_1_1visualiser_1_1ViridisInterpolation.html">Class ViridisInterpolation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="library_root.html#enums">Enums</a><ul>
<li class="toctree-l4"><a class="reference internal" href="enum_namespaceflamegpu_1a1adc39b89f4a6045c011c55a91339e4c.html">Enum AGENT_STATUS</a></li>
<li class="toctree-l4"><a class="reference internal" href="enum_namespaceflamegpu_1a2f06e5efd2a057b11a2fb53e711c443a.html">Enum CONDITION_RESULT</a></li>
<li class="toctree-l4"><a class="reference internal" href="enum_namespaceflamegpu_1a167df7c66e4cd9ff9a0fbc124d6a4825.html">Enum MessageSortingType</a></li>
<li class="toctree-l4"><a class="reference internal" href="enum_namespaceflamegpu_1a85851c7dc9bdb27265f3ee52194f6737.html">Enum Verbosity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="library_root.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1ad1d0646758e9e727e1b5c8765b01b902.html">Template Function flamegpu::agent_function_condition_wrapper</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a14f9e38e603f07fab8147506c76e38a0.html">Template Function flamegpu::agent_function_wrapper</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a0e9933d8e92fc85b481c5ffcec96e4c5.html">Function flamegpu::atomicHistogram1D</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a62702550faacab131476f2f0fd42b15d.html">Function flamegpu::atomicHistogram2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1ab142b7f3311b4d53df2ec36802361c18.html">Function flamegpu::atomicHistogram3D</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1ab6b7cc2d61ad5fc6ef4f30962f0e1c0c.html">Function flamegpu::calculateSpatialHash</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a98d812fe76f87a584031e516b3bd4d83.html">Function flamegpu::calculateSpatialHashFloat2</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a1c1e558eafa9efc336bcdac7fad3fe09.html">Function flamegpu::calculateSpatialHashFloat3</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a2b3ed80110a116bc60c58799d0b1889f.html">Function flamegpu::detail::allocateIDs</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a09c6bdb2a8c16c9b3a1cc2c1d2f47bef.html">Function flamegpu::detail::broadcastInitKernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1compute__capability_1af9dcaeeff2fdedfdf76c2b18b2e65b27.html">Function flamegpu::detail::compute_capability::checkComputeCapability</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1compute__capability_1a7f0af4d63855635deb3c7677c49e5267.html">Function flamegpu::detail::compute_capability::getComputeCapability</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1compute__capability_1ae0606d5a9a000e6ddb22d78393f898a7.html">Function flamegpu::detail::compute_capability::getDeviceName</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1compute__capability_1a0c075ac82e862f3994d0d84db60278b6.html">Function flamegpu::detail::compute_capability::getDeviceNames</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1compute__capability_1af76856b0a2e5d3e398aaaa3a72b4e374.html">Function flamegpu::detail::compute_capability::getNVRTCSupportedComputeCapabilties</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1compute__capability_1afc15d3bff48761ebeedca2d4614f1b51.html">Function flamegpu::detail::compute_capability::minimumCompiledComputeCapability</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1compute__capability_1abb3b3d68d537e51a33f598049605397d.html">Function flamegpu::detail::compute_capability::selectAppropraiteComputeCapability</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1cuda_1af35de91a893eaf7374e6877adba41e1f.html">Function flamegpu::detail::cuda::cudaFree</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1cuda_1a08f7154635858342de0413bf5dbdd7be.html">Function flamegpu::detail::cuda::cudaFreeHost</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1cuda_1a692af6493d6b046d530c8103d2a9f72a.html">Function flamegpu::detail::cuda::cuDevicePrimaryContextIsActive</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1cxxname_1a948dd262036f6afd955300d82100487b.html">Function flamegpu::detail::cxxname::getUnqualifiedName</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a51dd031c7a938c4c09838d15248e3d5d.html">Function flamegpu::detail::generateCollisionFlags</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1aa3219b89ee653bb03ca64a7ab0fc4719.html">Function flamegpu::detail::gpuAssert(cudaError_t, const char *, int)</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a9ba953de2543141a9af9414adbf943cf.html">Function flamegpu::detail::gpuAssert(CUresult, const char *, int)</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a6b99385f65506854d317cc1a27d486ff.html">Function flamegpu::detail::gpuLaunchAssert</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a419933d0a6877bbedcaa3de1488e2216.html">Function flamegpu::detail::init_curand</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1addf923315be7428b40babe312ebaa20b.html">Function flamegpu::detail::pbm_reorder_generic</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a5a0d93b73a06fc52c85ed73e29ef2b00.html">Function flamegpu::detail::reorder_array_messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1aeef1d2a6d0f532fb6992a5630c15508e.html">Function flamegpu::detail::scatter_all_generic</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a50ecc81102123a357ab5e0f48d4c4fc5.html">Template Function flamegpu::detail::scatter_generic</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a0ebbd2d7da1d1e0082c54e158df4fe6b.html">Function flamegpu::detail::scatter_new_agents</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a6e197109c62ecf2538e8710ef5bff51d.html">Function flamegpu::detail::scatter_position_generic</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1a3deccf1a44e498f8fb4e6ff4efd30606.html">Function flamegpu::detail::sm</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1wddm_1aadd153aff3aadf89010e0e515dc18a56.html">Function flamegpu::detail::wddm::deviceIsWDDM(int)</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1detail_1_1wddm_1a54675b333821503c2d45012182ca8b5b.html">Function flamegpu::detail::wddm::deviceIsWDDM()</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1ad31aa8a96f16f233806285ae39fe822c.html">Template Function flamegpu::getAgentVariableMaxFunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a71a0b028ba8c669fca81bc8b91c8161b.html">Template Function flamegpu::getAgentVariableMeanFunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1ad9ab3f3957c697d1ba77d0129c4e8d42.html">Template Function flamegpu::getAgentVariableMinFunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a46155a7c33d3922708b9eb440f974c43.html">Template Function flamegpu::getAgentVariableStandardDevFunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a008ad38c0accf8b9c904b89a49a80e16.html">Template Function flamegpu::getAgentVariableSumFunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1aef3737bc73df02c3cacdfe023e540fda.html">Function flamegpu::getGridPosition2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1af8bd0c23b13150691a8075e10e315df8.html">Function flamegpu::getGridPosition3D</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1ac19244e95de615218572437593f6f366.html">Function flamegpu::getHash2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1aecff32308539a40d36081f141c5bcee3.html">Function flamegpu::getHash3D</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a7a197dc32a2a7d5896c0e6f7159dd065.html">Function flamegpu::initToThreadIndex</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1a39c5c7fb5befdc5ea64afdb4e97f0e60.html">Function flamegpu::sortBuffer_kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1util_1a3f41558a845dbe92aeddd912ae685495.html">Function flamegpu::util::cleanup</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1util_1aec2a487b13e1a5c9c2fe292c5cda4fb0.html">Function flamegpu::util::clearRTCDiskCache</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1util_1_1nvtx_1ab909a4af7be046b5bacf9e0210ec8c44.html">Function flamegpu::util::nvtx::pop</a></li>
<li class="toctree-l4"><a class="reference internal" href="function_namespaceflamegpu_1_1util_1_1nvtx_1adf60f078081462ee25d17335e84da620.html">Function flamegpu::util::nvtx::push</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="library_root.html#variables">Variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1detail_1a61d3d707a6620585758c1efd3cea54a2.html">Variable flamegpu::detail::standard_deviation_add</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1detail_1a5e169c9830e27f3e46a57d103144d5d3.html">Variable flamegpu::detail::STANDARD_DEVIATION_MEAN</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1detail_1aae8849dcffeb32b7742994d953b7a726.html">Variable flamegpu::detail::STANDARD_DEVIATION_MEAN_mutex</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1detail_1a4a219a49a5e05388630e16350ba5c1f3.html">Variable flamegpu::detail::standard_deviation_subtract_mean</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1ae222c3a1e48085efbe98bf734bf18c47.html">Variable flamegpu::ID_NOT_SET</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1ae2461128afe905a603afcb7877188f29.html">Variable flamegpu::ID_VARIABLE_NAME</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1a8fdfd48619c64c23a7ce5fb573bb737b.html">Variable flamegpu::TELEMETRY_RANDOM_ID</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1util_1_1nvtx_1ae10adf9792fc2b0b7633eb6de2264822.html">Variable flamegpu::util::nvtx::colourCount</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1util_1_1nvtx_1a7387cf44905d30baa6d0ea9028040a2d.html">Variable flamegpu::util::nvtx::ENABLED</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1util_1_1nvtx_1ad8741a3a413fbc84d63b882881705bbc.html">Variable flamegpu::util::nvtx::palette</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1afe3afceec4bb90c840ea5482d7b07a97.html">Variable flamegpu::VERSION</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1abf99fff85270c03559c6846ce15c254f.html">Variable flamegpu::VERSION_BUILDMETADATA</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1ab2825ce1960a77bc8afbbd98b6305a44.html">Variable flamegpu::VERSION_FULL</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1ac29d48311f0cba829d4603734ba14450.html">Variable flamegpu::VERSION_MAJOR</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1abeeb7b039bde639c7627990c5f62e83d.html">Variable flamegpu::VERSION_MINOR</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1a6c1bfc357e2e82b0e575ec2b5b6a33f5.html">Variable flamegpu::VERSION_PATCH</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1a069e154449fb7dd97a34bc531ed9298c.html">Variable flamegpu::VERSION_PRERELEASE</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1a3afacc122b436ea9ab35959b1a8eff0f.html">Variable flamegpu::VERSION_STRING</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Colors_1a591a2e09088968ef4e9549ade22b5333.html">Variable flamegpu::visualiser::Stock::Colors::BLACK</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Colors_1a00e6f044ffe65490ec534820dc711801.html">Variable flamegpu::visualiser::Stock::Colors::BLUE</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Colors_1aad8474812ca5c495e3d427bac61c1065.html">Variable flamegpu::visualiser::Stock::Colors::GREEN</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Colors_1a5c18952ccee1c554960d0591212508e4.html">Variable flamegpu::visualiser::Stock::Colors::RED</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Colors_1a6a178b4824a681a995f9e4ff131af19a.html">Variable flamegpu::visualiser::Stock::Colors::WHITE</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1a20fa45b16191b081045ab552e8b2d642.html">Variable flamegpu::visualiser::Stock::Palettes::DARK2</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1a88eb71e0f17b9303a07ea89aa64bc1a2.html">Variable flamegpu::visualiser::Stock::Palettes::GREYS</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1a30cc45821bb2d273b8d88cc52ca569ca.html">Variable flamegpu::visualiser::Stock::Palettes::PASTEL</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1afe0ee1ad329fd208faffa923fc0cb07f.html">Variable flamegpu::visualiser::Stock::Palettes::PIYG</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1ae976b044a8dd59d5fae4b28dcff4c07b.html">Variable flamegpu::visualiser::Stock::Palettes::RDYLBU</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1a3bb28bea63506f9eb15100d55c68fa7e.html">Variable flamegpu::visualiser::Stock::Palettes::SET1</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1a1bd3aa65da115e2a07b9118fa6952e82.html">Variable flamegpu::visualiser::Stock::Palettes::SET2</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1a852a3b927ba4d6fd38f3be0b1c915c30.html">Variable flamegpu::visualiser::Stock::Palettes::YLGN</a></li>
<li class="toctree-l4"><a class="reference internal" href="variable_namespaceflamegpu_1_1visualiser_1_1Stock_1_1Palettes_1a0cfc07ba486999d845c4db0e8b74f152.html">Variable flamegpu::visualiser::Stock::Palettes::YLORRD</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="library_root.html#defines">Defines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="define_FLAMEGPUException_8h_1a3782b4c58365dfbff74733193c5b886e.html">Define DERIVED_FLAMEGPUException</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_FLAMEGPUDeviceException__device_8cuh_1a9e2b87f2547583d337b7db1b3abdf501.html">Define DTHROW</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunction__shim_8cuh_1a1c067606a392fd111d240d55377e79a9.html">Define FLAMEGPU_AGENT_FUNCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunctionCondition__shim_8cuh_1a18080498fb1ee3218b8b0ff14d7ec1af.html">Define FLAMEGPU_AGENT_FUNCTION_CONDITION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunctionCondition__shim_8cuh_1a6fff88c5da5c3f0eef80b3355a6f24f6.html">Define FLAMEGPU_AGENT_FUNCTION_CONDITION_DECL</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunctionCondition__shim_8cuh_1ab217c9e34b6e456355f0646cc6b2a03d.html">Define FLAMEGPU_AGENT_FUNCTION_CONDITION_DEF</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunction__shim_8cuh_1ac3079505c2f47e1259e2bce031896995.html">Define FLAMEGPU_AGENT_FUNCTION_DECL</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunction__shim_8cuh_1af994adf16ef22b7c456925ff5dc81cc7.html">Define FLAMEGPU_AGENT_FUNCTION_DEF</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAgentAPI_8cuh_1ad9d5573357effdcf7430c6c2024becc4.html">Define FLAMEGPU_CUSTOM_REDUCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAgentAPI_8cuh_1a64629b6c7aa246731d1657c3ad70996a.html">Define FLAMEGPU_CUSTOM_TRANSFORM</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunction__shim_8cuh_1a76f5ec2c762f0289e11d150131b80ef9.html">Define FLAMEGPU_DEVICE_FUNCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1a4a4750514dd45f70b587b29543fe7a27.html">Define FLAMEGPU_EXIT_CONDITION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1a1c604c9eb863599998429b48b31fe671.html">Define FLAMEGPU_EXIT_FUNCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1a1682b3b663340523820b7b1dc35ef180.html">Define FLAMEGPU_HOST_CONDITION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunction__shim_8cuh_1a92ddd2311e736cc418e2ed1092485ca1.html">Define FLAMEGPU_HOST_DEVICE_FUNCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1afd0f16608253df0496b74c78500282c5.html">Define FLAMEGPU_HOST_FUNCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1a954e4401282f8af04be0d59a74d9a836.html">Define FLAMEGPU_HOST_FUNCTION_DECL</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1ab68d3bcdcb4f213159622b8aa7b141b4.html">Define FLAMEGPU_HOST_FUNCTION_DEF</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1a45ad84203a419b7833ef1f21484648c8.html">Define FLAMEGPU_INIT_FUNCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAPI__macros_8h_1a779541ca72e6a0019460ace6d0a9d1ab.html">Define FLAMEGPU_STEP_FUNCTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_version_8h_1a3721686dc87c2ab44fd82ad98ffc21db.html">Define FLAMEGPU_VERSION</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_CUDAErrorChecking_8cuh_1a3f6ea8e9ef58125936d50d7e1181aa7a.html">Define gpuErrchk</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_CUDAErrorChecking_8cuh_1a05a1b794ed7313e0763388e626530d99.html">Define gpuErrchkDriverAPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_CUDAErrorChecking_8cuh_1aab94d05ca41ffb1aec281d2fee3014a5.html">Define gpuErrchkLaunch</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_compute__capability_8cuh_1ad60d966cdaec1b57d058f524aa17011b.html">Define INCLUDE_FLAMEGPU_DETAIL_COMPUTE_CAPABILITY_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_cuda_8cuh_1a9c31d7c60e221e40509cf23078be6088.html">Define INCLUDE_FLAMEGPU_DETAIL_CUDA_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_CUDAEventTimer_8cuh_1a8198d183b0ccfb69bfc71410d4718809.html">Define INCLUDE_FLAMEGPU_DETAIL_CUDAEVENTTIMER_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_curand_8cuh_1a63b7cca3f62e1a5015b2116f5c81d976.html">Define INCLUDE_FLAMEGPU_DETAIL_CURAND_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_wddm_8cuh_1ac989c101663ad6f80a14ae2ea1c6d587.html">Define INCLUDE_FLAMEGPU_DETAIL_WDDM_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_FLAMEGPUDeviceException_8cuh_1a1a757b8c1e833b86bfca9a577aed08c8.html">Define INCLUDE_FLAMEGPU_EXCEPTION_FLAMEGPUDEVICEEXCEPTION_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_FLAMEGPUDeviceException__device_8cuh_1a8970b890bde138df77fa8531f6166660.html">Define INCLUDE_FLAMEGPU_EXCEPTION_FLAMEGPUDEVICEEXCEPTION_DEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunctionData_8cuh_1abcd20b720bdde9dae536097d9b59ce83.html">Define INCLUDE_FLAMEGPU_MODEL_AGENTFUNCTIONDATA_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostAgentAPI_8cuh_1aebeab779536e0a99e81d374c5dd906cc.html">Define INCLUDE_FLAMEGPU_RUNTIME_AGENT_HOSTAGENTAPI_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunction_8cuh_1affe4f5c251678f8cb6a9da167dabbcb4.html">Define INCLUDE_FLAMEGPU_RUNTIME_AGENTFUNCTION_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunction__shim_8cuh_1ab99977b2d12596d8e7eb69f86fd2c0f7.html">Define INCLUDE_FLAMEGPU_RUNTIME_AGENTFUNCTION_SHIM_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunctionCondition_8cuh_1a574cefe207a9b2a90e1b48ecbac1bfed.html">Define INCLUDE_FLAMEGPU_RUNTIME_AGENTFUNCTIONCONDITION_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentFunctionCondition__shim_8cuh_1a4fade0adcfca1c63f63301ef0f4618cd.html">Define INCLUDE_FLAMEGPU_RUNTIME_AGENTFUNCTIONCONDITION_SHIM_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_Curve_8cuh_1a05ee33eb8cc0ac9d4f74b4bb3142e251.html">Define INCLUDE_FLAMEGPU_RUNTIME_DETAIL_CURVE_CURVE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_curve__rtc_8cuh_1a4af8369376d2fad37ccada340646f766.html">Define INCLUDE_FLAMEGPU_RUNTIME_DETAIL_CURVE_CURVE_RTC_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_DeviceCurve_8cuh_1ac857abbb40712ca7f6563e5a7da2003b.html">Define INCLUDE_FLAMEGPU_RUNTIME_DETAIL_CURVE_DEVICECURVE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostCurve_8cuh_1a825e691ebeb0c259e8ae491505933d42.html">Define INCLUDE_FLAMEGPU_RUNTIME_DETAIL_CURVE_HOSTCURVE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_DeviceAPI_8cuh_1ae19bcc534bdbb83776e9b23350a073d8.html">Define INCLUDE_FLAMEGPU_RUNTIME_DEVICEAPI_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_DeviceEnvironment_8cuh_1ae7c5eef3f136dde0a7ac60c9b2140ed0.html">Define INCLUDE_FLAMEGPU_RUNTIME_ENVIRONMENT_DEVICEENVIRONMENT_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_DeviceMacroProperty_8cuh_1a32074af98f8c5782285351cf69b8d6ba.html">Define INCLUDE_FLAMEGPU_RUNTIME_ENVIRONMENT_DEVICEMACROPROPERTY_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostEnvironment_8cuh_1a9439bb4d51a9ba9b0ad4b49e890c891a.html">Define INCLUDE_FLAMEGPU_RUNTIME_ENVIRONMENT_HOSTENVIRONMENT_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostMacroProperty_8cuh_1a70cfaf63c6acc69015cd98275824f801.html">Define INCLUDE_FLAMEGPU_RUNTIME_ENVIRONMENT_HOSTMACROPROPERTY_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageArray2DDevice_8cuh_1a2d970be19925286658ef10612418323d.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGEARRAY2D_MESSAGEARRAY2DDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageArray3DDevice_8cuh_1a1eac92a18d97d668a467428697f02f45.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGEARRAY3D_MESSAGEARRAY3DDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageArrayDevice_8cuh_1af8e2891480b9423ea605c599f3c7ed78.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGEARRAY_MESSAGEARRAYDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageBruteForceDevice_8cuh_1a908163ddb9bfbb81c3eabd54007c7d04.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGEBRUTEFORCE_MESSAGEBRUTEFORCEDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageBucketDevice_8cuh_1a55f537869b8e489d0323140c49f550c7.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGEBUCKET_MESSAGEBUCKETDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageNoneDevice_8cuh_1af35d3304468392badb3a3c3f490ed543.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGENONE_MESSAGENONEDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageSpatial2DDevice_8cuh_1a64a87e1d070382b34fd7106f97b4dad9.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGESPATIAL2D_MESSAGESPATIAL2DDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_MessageSpatial3DDevice_8cuh_1a2e44a936ef72b228e1b4022d142c6d39.html">Define INCLUDE_FLAMEGPU_RUNTIME_MESSAGING_MESSAGESPATIAL3D_MESSAGESPATIAL3DDEVICE_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentRandom_8cuh_1a3eebc33578d2ff0fdb30c72abeb28157.html">Define INCLUDE_FLAMEGPU_RUNTIME_RANDOM_AGENTRANDOM_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_HostRandom_8cuh_1ab0845d9275dbfdb0240951e427f889df.html">Define INCLUDE_FLAMEGPU_RUNTIME_RANDOM_HOSTRANDOM_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_AgentLoggingConfig__Reductions_8cuh_1aacf28c3f5165c20093972ddf87a62489.html">Define INCLUDE_FLAMEGPU_SIMULATION_AGENTLOGGINGCONFIG_REDUCTIONS_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_CubTemporaryMemory_8cuh_1a2f4c8a0e86e32b559fe22be0ae7e4d5a.html">Define INCLUDE_FLAMEGPU_SIMULATION_DETAIL_CUBTEMPORARYMEMORY_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_CUDAErrorChecking_8cuh_1a33258038bbc6328911803abfb1bc8eee.html">Define INCLUDE_FLAMEGPU_SIMULATION_DETAIL_CUDAERRORCHECKING_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_CUDAScatter_8cuh_1af7d2b03256f2cab4bb43e5205e14f106.html">Define INCLUDE_FLAMEGPU_SIMULATION_DETAIL_CUDASCATTER_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_EnvironmentManager_8cuh_1ad7769b9c612267ca56e7a7366e4583dd.html">Define INCLUDE_FLAMEGPU_SIMULATION_DETAIL_ENVIRONMENTMANAGER_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_RandomManager_8cuh_1a17038ff9ff09bc3005320b94089da9be.html">Define INCLUDE_FLAMEGPU_SIMULATION_DETAIL_RANDOMMANAGER_CUH_</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_FLAMEGPUException_8h_1ac900f7f4cbb8ade051915b56180eb89d.html">Define THROW</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_XMLLogger_8cu_1afa12b43d02fbd77db41a70be0733552a.html">Define XMLCheckResult</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_XMLStateReader_8cpp_1afa12b43d02fbd77db41a70be0733552a.html">Define XMLCheckResult</a></li>
<li class="toctree-l4"><a class="reference internal" href="define_XMLStateWriter_8cpp_1afa12b43d02fbd77db41a70be0733552a.html">Define XMLCheckResult</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="library_root.html#typedefs">Typedefs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1ae62625f2f2b70b2b5f9d218db249d8e1.html">Typedef flamegpu::AgentFunctionConditionWrapper</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1afdb1ab69f8ad55bab90f8cf449a89f6d.html">Typedef flamegpu::AgentFunctionWrapper</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1detail_1aea675236a91735a8b1474f255af53f0f.html">Typedef flamegpu::detail::CUDAMessageMap</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1detail_1a3244d1e124bb3b9b62bc13480c080bd1.html">Typedef flamegpu::detail::CUDAMessageMapPair</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1detail_1a22cad826da222ea86c6a2fe84dfeb72d.html">Typedef flamegpu::detail::curandState</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1detail_1a12800307b68a0a7dbb2822d0b3a702f7.html">Typedef flamegpu::detail::StateMemoryMap</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1detail_1af3855ec58aee3d213032029ee4dee37d.html">Typedef flamegpu::detail::StateMemoryMapPair</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1detail_1_1StaticAssert_1a3cd8bb106aa7af28c329dcaabf65fe4f.html">Typedef flamegpu::detail::StaticAssert::false_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1detail_1_1StaticAssert_1ab6c9bbfbdc8c7089b3b86d19a066eebc.html">Typedef flamegpu::detail::StaticAssert::true_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1afe2ca90ee1ba3f7638e0a640dda346b3.html">Typedef flamegpu::DeviceAgentVector</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a5607538d6f1b97ef411a40c9d52f71b1.html">Typedef flamegpu::FLAMEGPU_EXIT_CONDITION_POINTER</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a677d0646677414a5fe34a580891c1296.html">Typedef flamegpu::FLAMEGPU_EXIT_FUNCTION_POINTER</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a13e4b64ac18db61a5da0c453baf89b1d.html">Typedef flamegpu::FLAMEGPU_HOST_CONDITION_POINTER</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a9bfe18618d31195e57596fba50d28af9.html">Typedef flamegpu::FLAMEGPU_HOST_FUNCTION_POINTER</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a49027ae818bd10917878571d0aab9eae.html">Typedef flamegpu::FLAMEGPU_INIT_FUNCTION_POINTER</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a327d7686ae940faa86f0119b6c7da377.html">Typedef flamegpu::FLAMEGPU_STEP_FUNCTION_POINTER</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1aa38504d5d161ede66606cf62524fb9e2.html">Typedef flamegpu::id_t</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a83d0ff667b27ea2b2ec5677bf0c24253.html">Typedef flamegpu::IntT</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1a4f33b71f99d74a889a0ac6c23ddabc15.html">Typedef flamegpu::size_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1util_1aa7b566b0594a93a119a5514350637c4c.html">Typedef flamegpu::util::StringPair</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1util_1aecb766a8c1523feef0016f93a23fcc05.html">Typedef flamegpu::util::StringPairMap</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1util_1afbbdc01d25d7a25770ebe2dda9327653.html">Typedef flamegpu::util::StringPairUnorderedMap</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1aebf720d85bdb918165592c59575fe998.html">Typedef flamegpu::VariableMap</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1visualiser_1af8b0a3c3a081bb0366b9867e22af0d99.html">Typedef flamegpu::visualiser::iDiscreteColor</a></li>
<li class="toctree-l4"><a class="reference internal" href="typedef_namespaceflamegpu_1_1visualiser_1ae4a92f51d0b0c323285c6df3f97b5910.html">Typedef flamegpu::visualiser::uDiscreteColor</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/index.html#flame-gpu-design-philosophy">FLAME GPU Design Philosophy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/index.html#creating-a-project">Creating a Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/index.html#structure-of-a-flame-gpu-2-program">Structure of a FLAME GPU 2 Program</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#agent-host-function-definitions">Agent/Host Function Definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#model-declaration">Model Declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#initialisation">Initialisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#execution">Execution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/index.html#tutorial-creating-the-circles-model">Tutorial: Creating the Circles Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#introducing-the-circles-model">Introducing The Circles Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#configuring-cmake">Configuring CMake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#opening-the-project">Opening the Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#model-description">Model Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#message-description">Message Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#agent-description">Agent Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#environment-description">Environment Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#agent-function-description-implementation">Agent Function Description  Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#execution-order">Execution Order</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#initialisation-function">Initialisation Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#configuring-the-simulation">Configuring the Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#configuring-logging-optional">Configuring Logging (Optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#visualisation-config-optional">Visualisation Config (Optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#running-the-simulation">Running the Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/index.html#complete-tutorial-code">Complete Tutorial Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/index.html#related-links">Related Links</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/FLAMEGPU/FLAMEGPU2/discussions">Forum</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #4d4d4d" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">FLAME GPU 2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Program Listing for File CUDASimulation.cu</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/program_listing_file_src_flamegpu_simulation_CUDASimulation.cu.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="program-listing-for-file-cudasimulation-cu">
<span id="program-listing-file-src-flamegpu-simulation-cudasimulation-cu"></span><h1>Program Listing for File CUDASimulation.cu<a class="headerlink" href="#program-listing-for-file-cudasimulation-cu" title="Permalink to this heading"></a></h1>
<p>↰ <a class="reference internal" href="file_src_flamegpu_simulation_CUDASimulation.cu.html#file-src-flamegpu-simulation-cudasimulation-cu"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">src/flamegpu/simulation/CUDASimulation.cu</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/simulation/CUDASimulation.h&quot;</span>


<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/detail/curand.cuh&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/model/AgentFunctionData.cuh&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/model/LayerData.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/model/AgentDescription.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/model/SubModelData.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/model/SubAgentData.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/runtime/HostAPI.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/simulation/detail/CUDAScanCompaction.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/util/nvtx.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/detail/compute_capability.cuh&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/detail/SignalHandlers.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/detail/wddm.cuh&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/detail/SteadyClockTimer.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/detail/CUDAEventTimer.cuh&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/runtime/detail/curve/curve_rtc.cuh&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/runtime/HostFunctionCallback.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/runtime/messaging.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/simulation/detail/CUDAAgent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/simulation/detail/CUDAMessage.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/simulation/LoggingConfig.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/simulation/LogFrame.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/simulation/RunPlan.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/version.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/model/AgentFunctionDescription.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/io/Telemetry.h&quot;</span>
<span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;flamegpu/visualiser/FLAMEGPU_Visualisation.h&quot;</span>
<span class="cp">#endif</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">flamegpu</span><span class="w"> </span><span class="p">{</span>

<span class="k">namespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// file-scope only variable used to cache the driver mode</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">deviceUsingWDDM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Inlined method in the anonymous namespace to create a new timer, subject to the driver model.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getDriverAppropriateTimer</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">is_ensemble</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">deviceUsingWDDM</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">is_ensemble</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAEventTimer</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">SteadyClockTimer</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// anonymous namespace</span>

<span class="n">CUDASimulation</span><span class="o">::</span><span class="n">CUDASimulation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ModelDescription</span><span class="o">&amp;</span><span class="w"> </span><span class="n">_model</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">_isSWIG</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="p">(</span><span class="n">_model</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">_isSWIG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">initialise</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">CUDASimulation</span><span class="o">::</span><span class="n">CUDASimulation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ModelData</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_model</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">_isSWIG</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Simulation</span><span class="p">(</span><span class="n">_model</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">step_count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">elapsedSecondsSimulation</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">elapsedSecondsInitFunctions</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">elapsedSecondsExitFunctions</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">elapsedSecondsRTCInitialisation</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">macro_env</span><span class="p">(</span><span class="o">*</span><span class="n">_model</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">({})</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">run_log</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">RunLog</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">streams</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cudaStream_t</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">singletonsInitialised</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">rtcInitialised</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="cp">#if __CUDACC_VER_MAJOR__ &gt;= 12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">cudaContextID</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uint64_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">())</span>
<span class="cp">#endif  </span><span class="c1">// __CUDACC_VER_MAJOR__ &gt;= 12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">isPureRTC</span><span class="p">(</span><span class="n">detectPureRTC</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">isSWIG</span><span class="p">(</span><span class="n">_isSWIG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">initOffsetsAndMap</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Register the signal handler.</span>
<span class="w">    </span><span class="n">detail</span><span class="o">::</span><span class="n">SignalHandlers</span><span class="o">::</span><span class="n">registerSignalHandlers</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// populate the CUDA agent map</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">agents</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// create new cuda agent and add to the map</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// insert into map using value_type and store a reference to the map pair</span>
<span class="w">        </span><span class="n">agent_map</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">)).</span><span class="n">first</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// populate the CUDA message map</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">messages</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// create new cuda message and add to the map</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it_m</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">mm</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it_m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">message_map</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">it_m</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">it_m</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// populate the CUDA submodel map</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">smm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">submodels</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// create new cuda message and add to the map</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it_sm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smm</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it_sm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">smm</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it_sm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">submodel_map</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">it_sm</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">CUDASimulation</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="p">(</span><span class="n">it_sm</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Determine which agents will be spatially sorted</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">determineAgentsToSort</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">detectPureRTC</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ModelData</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">_model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_model</span><span class="o">-&gt;</span><span class="n">agents</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">af</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">af</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">func</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">af</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// TODO: In future this will need to be extended for new forms of device function, e.g. device init</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_model</span><span class="o">-&gt;</span><span class="n">submodels</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">as</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">detectPureRTC</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="p">))</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">CUDASimulation</span><span class="o">::</span><span class="n">CUDASimulation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SubModelData</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">submodel_desc</span><span class="p">,</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="w"> </span><span class="o">*</span><span class="n">master_model</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Simulation</span><span class="p">(</span><span class="n">submodel_desc</span><span class="p">,</span><span class="w"> </span><span class="n">master_model</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">step_count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">macro_env</span><span class="p">(</span><span class="o">*</span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">run_log</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">RunLog</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">streams</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cudaStream_t</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">singletonsInitialised</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">rtcInitialised</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="cp">#if __CUDACC_VER_MAJOR__ &gt;= 12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">cudaContextID</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uint64_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">())</span>
<span class="cp">#endif  </span><span class="c1">// __CUDACC_VER_MAJOR__ &gt;= 12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">isPureRTC</span><span class="p">(</span><span class="n">master_model</span><span class="o">-&gt;</span><span class="n">isPureRTC</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">isSWIG</span><span class="p">(</span><span class="n">master_model</span><span class="o">-&gt;</span><span class="n">isSWIG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">initOffsetsAndMap</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Ensure submodel is valid</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="o">-&gt;</span><span class="n">exitConditions</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="o">-&gt;</span><span class="n">exitConditionCallbacks</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">max_steps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidSubModel</span><span class="p">(</span><span class="s">&quot;Model &#39;%s&#39; does not contain any exit conditions or exit condition callbacks and submodel &#39;%s&#39; max steps is set to 0, SubModels must exit of their own accord, &quot;</span>
<span class="w">            </span><span class="s">&quot;in CUDASimulation::CUDASimulation().&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// populate the CUDA agent map (With SubAgents!)</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">agents</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// create new cuda agent and add to the map</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Locate the mapping</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">_mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">subagents</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_mapping</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">subagents</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Agent is mapped, create subagent</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SubAgentData</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mapping</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Locate the master agent</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">AgentData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">masterAgentDesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">masterAgent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">masterAgentDesc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidParent</span><span class="p">(</span><span class="s">&quot;Master agent description has expired, in CUDASimulation SubModel constructor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">masterAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master_model</span><span class="o">-&gt;</span><span class="n">agent_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">masterAgentDesc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">            </span><span class="n">agent_map</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">masterAgent</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Agent is not mapped, create regular agent</span>
<span class="w">            </span><span class="n">agent_map</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">)).</span><span class="n">first</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span><span class="c1">// insert into map using value_type</span>

<span class="w">    </span><span class="c1">// populate the CUDA message map (Sub Messages not currently supported)</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">messages</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// create new cuda message and add to the map</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it_m</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">mm</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it_m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">message_map</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">it_m</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">it_m</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// populate the CUDA submodel map</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">smm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">submodels</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// create new cuda model and add to the map</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it_sm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smm</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it_sm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">smm</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it_sm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">submodel_map</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">it_sm</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">CUDASimulation</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="p">(</span><span class="n">it_sm</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Submodels all run quiet/not verbose by default</span>
<span class="w">    </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Default</span><span class="p">;</span>
<span class="w">    </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">submodel_desc</span><span class="o">-&gt;</span><span class="n">max_steps</span><span class="p">;</span>
<span class="w">    </span><span class="n">CUDAConfig</span><span class="p">().</span><span class="n">is_submodel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Determine which agents will be spatially sorted</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">determineAgentsToSort</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">CUDASimulation</span><span class="o">::~</span><span class="n">CUDASimulation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Ensure we destruct with the right device, otherwise we could dealloc pointers on the wrong device</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">t_device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaGetDevice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_device_id</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_device_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">deviceInitialised</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">deviceInitialised</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="n">deviceInitialised</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">submodel_map</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w">  </span><span class="c1">// Test</span>
<span class="w">    </span><span class="c1">// De-initialise, freeing singletons?</span>
<span class="w">    </span><span class="c1">// @todo - this is unsafe in a destructor as it may invoke cuda commands.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">singletonsInitialised</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">singletons</span><span class="p">;</span>
<span class="w">        </span><span class="n">singletons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// We must explicitly delete all cuda members before we cuda device reset</span>
<span class="w">    </span><span class="n">agent_map</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">message_map</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">submodel_map</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">host_api</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">macro_env</span><span class="p">.</span><span class="n">free</span><span class="p">();</span>
<span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">    </span><span class="n">visualisation</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w">  </span><span class="c1">// Might want to force destruct this, as user could hold a ModelVis that has shared ptr</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="c1">// Destroy streams, potentially unsafe in a destructor as it will invoke cuda commands.</span>
<span class="w">    </span><span class="c1">// Do this once to re-use existing streams rather than per-step.</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">destroyStreams</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Reset the active device if not the device used for this simulation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_device_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">deviceInitialised</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="n">t_device_id</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">initFunctions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::initFunctions&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">initFunctionsTimer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">SteadyClockTimer</span><span class="p">());</span>
<span class="w">    </span><span class="n">initFunctionsTimer</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Ensure singletons have been initialised</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Execute normal init functions</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">initFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">initFunctions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">initFn</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Execute init function callbacks (python)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">initFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">initFunctionCallbacks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">initFn</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Check if host agent creation was used in init functions</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">initFunctions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">initFunctionCallbacks</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Sync any device vectors, before performing host agent creation</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ca</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ca</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">resetPopulationVecs</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">processHostAgentCreation</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Record, store and output the elapsed time of the step.</span>
<span class="w">    </span><span class="n">initFunctionsTimer</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsInitFunctions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initFunctionsTimer</span><span class="o">-&gt;</span><span class="n">getElapsedSeconds</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">timing</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Verbose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Init Function Processing time: %.6f s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsInitFunctions</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">exitFunctions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::exitFunctions&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">exitFunctionsTimer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">SteadyClockTimer</span><span class="p">());</span>
<span class="w">    </span><span class="n">exitFunctionsTimer</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Ensure singletons have been initialised</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Execute exit functions</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exitFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">exitFunctions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">exitFn</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Execute any exit functions from swig/python</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exitFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">exitFunctionCallbacks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">exitFn</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Record, store and output the elapsed time of the step.</span>
<span class="w">    </span><span class="n">exitFunctionsTimer</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsExitFunctions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exitFunctionsTimer</span><span class="o">-&gt;</span><span class="n">getElapsedSeconds</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">timing</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Verbose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exit Function Processing time: %.6f s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsExitFunctions</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">detail</span><span class="w"> </span><span class="p">{</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Dims</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">calculateSpatialHashFloat3</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">xyz</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">binIndex</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envMin</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envWidth</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gridDim</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TID</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Compute hash (effectivley an index for to a bin within the partitioning grid in this case)</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">xyz</span><span class="p">[</span><span class="n">TID</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">envMin</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)),</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">xyz</span><span class="p">[</span><span class="n">TID</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">envMin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">y</span><span class="p">)),</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">xyz</span><span class="p">[</span><span class="n">TID</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">envMin</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">z</span><span class="p">))</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Compute and set the bin index</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bindex</span><span class="p">;</span>

<span class="w">        </span><span class="n">bindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span>
<span class="w">            </span><span class="p">(</span><span class="n">gridPos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="c1">// z</span>
<span class="w">                </span><span class="p">(</span><span class="n">gridPos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">              </span><span class="c1">// y</span>
<span class="w">                </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w">                           </span><span class="c1">// x</span>

<span class="w">        </span><span class="n">binIndex</span><span class="p">[</span><span class="n">TID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bindex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">calculateSpatialHashFloat2</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">xy</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">binIndex</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envMin</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envWidth</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gridDim</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TID</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Compute hash (effectivley an index for to a bin within the partitioning grid in this case)</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">xy</span><span class="p">[</span><span class="n">TID</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">envMin</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)),</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">xy</span><span class="p">[</span><span class="n">TID</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">envMin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">y</span><span class="p">)),</span>
<span class="w">            </span><span class="mi">0</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Compute and set the bin index</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bindex</span><span class="p">;</span>

<span class="w">        </span><span class="n">bindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span>
<span class="w">            </span><span class="p">(</span><span class="n">gridPos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">              </span><span class="c1">// y</span>
<span class="w">            </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w">                            </span><span class="c1">// x</span>

<span class="w">        </span><span class="n">binIndex</span><span class="p">[</span><span class="n">TID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bindex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">calculateSpatialHash</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">binIndex</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envMin</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envWidth</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gridDim</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TID</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Compute hash (effectivley an index for to a bin within the partitioning grid in this case)</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">x</span><span class="p">[</span><span class="n">TID</span><span class="p">]</span><span class="o">-</span><span class="n">envMin</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)),</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">y</span><span class="p">[</span><span class="n">TID</span><span class="p">]</span><span class="o">-</span><span class="n">envMin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">gridDim</span><span class="p">.</span><span class="n">y</span><span class="p">)),</span>
<span class="w">            </span><span class="mi">0</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// If 3D, set 3rd component</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floorf</span><span class="p">(((</span><span class="n">z</span><span class="p">[</span><span class="n">TID</span><span class="p">]</span><span class="o">-</span><span class="n">envMin</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">envWidth</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">gridDim</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Compute and set the bin index</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bindex</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span>
<span class="w">            </span><span class="p">(</span><span class="n">gridPos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="c1">// z</span>
<span class="w">            </span><span class="p">(</span><span class="n">gridPos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">              </span><span class="c1">// y</span>
<span class="w">            </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w">                           </span><span class="c1">// x</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span>
<span class="w">            </span><span class="p">(</span><span class="n">gridPos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">              </span><span class="c1">// y</span>
<span class="w">            </span><span class="n">gridPos</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w">                            </span><span class="c1">// x</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">binIndex</span><span class="p">[</span><span class="n">TID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bindex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">determineAgentsToSort</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">agents</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Iterate agents and then agent functions to find any functions which use spatial messaging</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mf</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it_f</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">mf</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it_f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">message_input</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Check if this agent function uses 3D spatial messages</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">getSortingType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">MessageSortingType</span><span class="o">::</span><span class="n">spatial3D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Agent uses spatial, check it has correct variables</span>
<span class="w">                    </span><span class="n">CAgentDescription</span><span class="w"> </span><span class="nf">ad</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ad</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;z&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;z&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">type_index</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                            </span><span class="n">y</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">type_index</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                            </span><span class="n">z</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">type_index</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">sortTriggers3D</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ad</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;xyz&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">xyz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;xyz&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xyz</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">type_index</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">xyz</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">sortTriggers3D</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Check if this agent function uses 2D spatial messages</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">getSortingType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">MessageSortingType</span><span class="o">::</span><span class="n">spatial2D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Agent uses spatial, check it has correct variables</span>
<span class="w">                    </span><span class="n">CAgentDescription</span><span class="w"> </span><span class="nf">ad</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ad</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">type_index</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                            </span><span class="n">y</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">type_index</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">sortTriggers2D</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ad</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;xy&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;xy&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">type_index</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">xy</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">sortTriggers2D</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">spatialSortAgent_async</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">funcName</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">agentName</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">streamId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fetch the appropriate message name</span>
<span class="w">    </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">agentName</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_list_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Can&#39;t sort no agents</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">state_list_size</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CAgentDescription</span><span class="w"> </span><span class="nf">cudaAgentData</span><span class="p">(</span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getAgentDescription</span><span class="p">());</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">funcData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaAgentData</span><span class="p">.</span><span class="n">getFunction</span><span class="p">(</span><span class="n">funcName</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">funcData</span><span class="p">.</span><span class="n">hasMessageInput</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;Function %s registered for auto-spatial sorting but input message type not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">funcName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">messageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">funcData</span><span class="p">.</span><span class="n">getMessageInput</span><span class="p">().</span><span class="n">getName</span><span class="p">();</span>
<span class="w">    </span><span class="n">MessageBruteForce</span><span class="o">::</span><span class="n">Data</span><span class="o">*</span><span class="w"> </span><span class="n">msgData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">messages</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">messageName</span><span class="p">).</span><span class="n">get</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Get the spatial metadata</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span>
<span class="w">    </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envMin</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envMax</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">envWidth</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">detail</span><span class="o">::</span><span class="n">Dims</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gridDim</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">messageSpatialData2D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">MessageSpatial2D</span><span class="o">::</span><span class="n">Data</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">msgData</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">messageSpatialData2D</span><span class="o">-&gt;</span><span class="n">radius</span><span class="p">;</span>
<span class="w">        </span><span class="n">envMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">messageSpatialData2D</span><span class="o">-&gt;</span><span class="n">minX</span><span class="p">,</span><span class="w"> </span><span class="n">messageSpatialData2D</span><span class="o">-&gt;</span><span class="n">minY</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">};</span>
<span class="w">        </span><span class="n">envMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">messageSpatialData2D</span><span class="o">-&gt;</span><span class="n">maxX</span><span class="p">,</span><span class="w"> </span><span class="n">messageSpatialData2D</span><span class="o">-&gt;</span><span class="n">maxY</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">messageSpatialData3D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">MessageSpatial3D</span><span class="o">::</span><span class="n">Data</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">msgData</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">messageSpatialData3D</span><span class="o">-&gt;</span><span class="n">radius</span><span class="p">;</span>
<span class="w">        </span><span class="n">envMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">messageSpatialData3D</span><span class="o">-&gt;</span><span class="n">minX</span><span class="p">,</span><span class="w"> </span><span class="n">messageSpatialData3D</span><span class="o">-&gt;</span><span class="n">minY</span><span class="p">,</span><span class="w"> </span><span class="n">messageSpatialData3D</span><span class="o">-&gt;</span><span class="n">minZ</span><span class="p">};</span>
<span class="w">        </span><span class="n">envMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">messageSpatialData3D</span><span class="o">-&gt;</span><span class="n">maxX</span><span class="p">,</span><span class="w"> </span><span class="n">messageSpatialData3D</span><span class="o">-&gt;</span><span class="n">maxY</span><span class="p">,</span><span class="w"> </span><span class="n">messageSpatialData3D</span><span class="o">-&gt;</span><span class="n">maxZ</span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">        </span><span class="n">envMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">};</span>
<span class="w">        </span><span class="n">envMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">envWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{(</span><span class="n">envMax</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">envMin</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">envMax</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">envMin</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">envMax</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">envMin</span><span class="p">.</span><span class="n">z</span><span class="p">)};</span>
<span class="w">        </span><span class="n">gridDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">envWidth</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ceilf</span><span class="p">(</span><span class="n">envWidth</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">radius</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">envWidth</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ceilf</span><span class="p">(</span><span class="n">envWidth</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">radius</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">envWidth</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ceilf</span><span class="p">(</span><span class="n">envWidth</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">radius</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="c1">// Any agent in this list is guaranteed to have x, y, z (or xyz vec versions) and _auto_sort_bin_index vars - used in the computation of spatial hash</span>
<span class="w">    </span><span class="c1">// TODO: User could supply alternatives to &quot;x&quot;, &quot;y&quot;, &quot;z&quot; to use alternative variables?</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">xPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">yPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">zPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">xyPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xyzPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Agent3D</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cudaAgentData</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;xyz&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">xyzPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateVariablePtr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xyz&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Agent2D</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cudaAgentData</span><span class="p">.</span><span class="n">hasVariable</span><span class="p">(</span><span class="s">&quot;xy&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">xyPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateVariablePtr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xy&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">xPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateVariablePtr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">yPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateVariablePtr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">zPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Agent3D</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateVariablePtr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;z&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">binIndexPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateVariablePtr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_auto_sort_bin_index&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Compute occupancy</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The launch configurator returned block size</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minGridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The minimum grid size needed to achieve the // maximum occupancy for a full device // launch</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The actual grid size needed, based on input size</span>
<span class="w">    </span><span class="n">cudaOccupancyMaxPotentialBlockSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minGridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">calculateSpatialHash</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">);</span>

<span class="w">    </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sm_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">error_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">getDevicePtr</span><span class="p">(</span><span class="n">streamId</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
<span class="w">    </span><span class="n">sm_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">error_buffer</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="c1">// Launch kernel</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xyzPtr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">calculateSpatialHashFloat3</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">sm_size</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">xyzPtr</span><span class="p">),</span>
<span class="w">            </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">binIndexPtr</span><span class="p">),</span>
<span class="w">            </span><span class="n">envMin</span><span class="p">,</span>
<span class="w">            </span><span class="n">envWidth</span><span class="p">,</span>
<span class="w">            </span><span class="n">gridDim</span><span class="p">,</span>
<span class="w">            </span><span class="n">state_list_size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xyPtr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">calculateSpatialHashFloat2</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">sm_size</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">xyPtr</span><span class="p">),</span>
<span class="w">            </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">binIndexPtr</span><span class="p">),</span>
<span class="w">            </span><span class="n">envMin</span><span class="p">,</span>
<span class="w">            </span><span class="n">envWidth</span><span class="p">,</span>
<span class="w">            </span><span class="n">gridDim</span><span class="p">,</span>
<span class="w">            </span><span class="n">state_list_size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">calculateSpatialHash</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">sm_size</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">xPtr</span><span class="p">),</span>
<span class="w">            </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">yPtr</span><span class="p">),</span>
<span class="w">            </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">zPtr</span><span class="p">),</span>
<span class="w">            </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">binIndexPtr</span><span class="p">),</span>
<span class="w">            </span><span class="n">envMin</span><span class="p">,</span>
<span class="w">            </span><span class="n">envWidth</span><span class="p">,</span>
<span class="w">            </span><span class="n">gridDim</span><span class="p">,</span>
<span class="w">            </span><span class="n">state_list_size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">gpuErrchkLaunch</span><span class="p">();</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">host_api</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Calculate max bit (cub::DeviceRadixSort end bit is exclusive and 0-indexed)</span>
<span class="w">    </span><span class="c1">// https://math.stackexchange.com/a/160299/126129</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">z</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">host_api</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">(</span><span class="n">agentName</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">).</span><span class="n">sort_async</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;_auto_sort_bin_index&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">HostAgentAPI</span><span class="o">::</span><span class="n">Asc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_bit</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">streamId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">step</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;CUDASimulation::step &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">step_count</span><span class="p">)).</span><span class="n">c_str</span><span class="p">()};</span>
<span class="w">    </span><span class="c1">// Ensure singletons have been initialised</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Time the individual step, using a CUDAEventTimer if possible, else a steadyClockTimer.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stepTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDriverAppropriateTimer</span><span class="p">(</span><span class="n">getCUDAConfig</span><span class="p">().</span><span class="n">is_ensemble</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getCUDAConfig</span><span class="p">().</span><span class="n">is_submodel</span><span class="p">);</span>
<span class="w">    </span><span class="n">stepTimer</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Init any unset agent IDs</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">assignAgentIDs</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// If verbose, print the step number.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Verbose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Processing Simulation Step %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">step_count</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="c1">// Ensure there are enough streams to execute the layer.</span>
<span class="w">    </span><span class="c1">// Taking into consideration if in-layer concurrency is disabled or not.</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMaximumLayerWidth</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">createStreams</span><span class="p">(</span><span class="n">nStreams</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Reset message list flags</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">message_map</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">message_map</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setTruncateMessageListFlag</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Execute each layer of the simulation.</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">layerIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Execute the individual layer</span>
<span class="w">        </span><span class="n">stepLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span><span class="w"> </span><span class="n">layerIndex</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Increment counter</span>
<span class="w">        </span><span class="o">++</span><span class="n">layerIndex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Run the step functions (including pyhton.)</span>
<span class="w">    </span><span class="n">stepStepFunctions</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Run the exit conditons, detecting wheter or not any we</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">exitRequired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">stepExitConditions</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Set message counts to zero, and set flags to update state of non-persistent message lists</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">message_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getMessageData</span><span class="p">().</span><span class="n">persistent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setMessageCount</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setTruncateMessageListFlag</span><span class="p">();</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setPBMConstructionRequiredFlag</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Record, store and output the elapsed time of the step.</span>
<span class="w">    </span><span class="n">stepTimer</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">stepMilliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stepTimer</span><span class="o">-&gt;</span><span class="n">getElapsedSeconds</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">stepMilliseconds</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">timing</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Verbose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Resolution is 0.5 microseconds, so print to 1 us.</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Step %d Processing time: %.6f s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">step_count</span><span class="p">,</span><span class="w"> </span><span class="n">stepMilliseconds</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Update step count at the end of the step - when it has completed.</span>
<span class="w">    </span><span class="n">incrementStepCounter</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Update the log for the step.</span>
<span class="w">    </span><span class="n">processStepLog</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// Return false if any exit condition&#39;s passed.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">exitRequired</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">stepLayer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">LayerData</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">layer</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">layerIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;stepLayer &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">layerIndex</span><span class="p">)).</span><span class="n">c_str</span><span class="p">()};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">message_name</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// If the layer contains a sub model, it can only execute the sub model.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">sub_model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">synchronizeAllStreams</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">submodel_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">sub_model</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">resetStepCounter</span><span class="p">();</span>
<span class="w">        </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">simulate</span><span class="p">();</span>
<span class="w">        </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Next layer, this layer cannot also contain agent functions</span>
<span class="w">        </span><span class="c1">// Ensure synchronisation has occurred.</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">synchronizeAllStreams</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Track stream index</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Sum the total number of threads being launched in the layer</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sync the environment once per layer (incase Host Fns, or submodel have changed it)</span>
<span class="w">    </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">updateDevice_async</span><span class="p">(</span><span class="n">getStream</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Spatially sort the agents</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_des</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">agent_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">func_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">sortPeriod</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">step_count</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">sortPeriod</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sortTriggers3D</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">sortTriggers3D</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">spatialSortAgent_async</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">,</span><span class="w"> </span><span class="n">Agent3D</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sortTriggers2D</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">sortTriggers2D</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">spatialSortAgent_async</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">,</span><span class="w"> </span><span class="n">Agent2D</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// No explicit sync, sorts should be in same stream as eventual kernel launch (digging deep, the underlying scatter method does have a sync though)</span>
<span class="w">    </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Map agent memory</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_des</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">agent_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">rtc_func_condition_name</span><span class="p">.</span><span class="n">empty</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">func_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">            </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">condition_range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;condition map &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">).</span><span class="n">c_str</span><span class="p">()};</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_list_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">resize</span><span class="p">(</span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">AGENT_DEATH</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Configure runtime access of the functions variables within the FLAME_API object</span>
<span class="w">            </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">mapRuntimeVariables</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="n">instance_id</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Zero the scan flag that will be written to</span>
<span class="w">            </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">zero_async</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">AGENT_DEATH</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// No sync, this occurs in same stream as dependent kernel launch</span>

<span class="w">            </span><span class="c1">// Push function&#39;s RTC cache to device if using RTC</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">rtc_func_condition_name</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rtc_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getRTCHeader</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_condition&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Sync EnvManager&#39;s RTC cache with RTC header&#39;s cache</span>
<span class="w">                </span><span class="n">rtc_header</span><span class="p">.</span><span class="n">updateEnvCache</span><span class="p">(</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getHostBuffer</span><span class="p">(),</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getBufferLen</span><span class="p">());</span>
<span class="w">                </span><span class="c1">// Push RTC header&#39;s cache to device</span>
<span class="w">                </span><span class="n">rtc_header</span><span class="p">.</span><span class="n">updateDevice_async</span><span class="p">(</span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getRTCInstantiation</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_condition&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">curve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getCurve</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_condition&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">curve</span><span class="p">.</span><span class="n">updateDevice_async</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// No sync, kernel launch should be in same stream</span>

<span class="w">            </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// If any condition kernel needs to be executed, do so, by checking the number of threads from before.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalThreads</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Ensure RandomManager is the correct size to accommodate all threads to be launched</span>
<span class="w">        </span><span class="n">detail</span><span class="o">::</span><span class="n">curandState</span><span class="w"> </span><span class="o">*</span><span class="n">d_rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">totalThreads</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// Track which stream to use for concurrency</span>
<span class="w">        </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Sum the total number of threads being launched in the layer, for rng offsetting.</span>
<span class="w">        </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Launch function condition kernels</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_des</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">agent_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">rtc_func_condition_name</span><span class="p">.</span><span class="n">empty</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">func_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">                </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">condition_range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;condition &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">).</span><span class="n">c_str</span><span class="p">()};</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_agent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;Agent function condition refers to expired agent.&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">agent_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">func_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">);</span>

<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_list_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The launch configurator returned block size</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">minGridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The minimum grid size needed to achieve the // maximum occupancy for a full device // launch</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The actual grid size needed, based on input size</span>

<span class="w">                </span><span class="c1">//  Agent function condition kernel wrapper args</span>
<span class="w">                </span><span class="n">detail</span><span class="o">::</span><span class="n">curandState</span><span class="w"> </span><span class="o">*</span><span class="n">t_rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_rng</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">totalThreads</span><span class="p">;</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">scanFlag_agentDeath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">Config</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">AGENT_DEATH</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">).</span><span class="n">d_ptrs</span><span class="p">.</span><span class="n">scan_flag</span><span class="p">;</span>
<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">error_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">getDevicePtr</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="c1">// switch between normal and RTC agent function condition</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// calculate the grid block size for agent function condition</span>
<span class="w">                    </span><span class="n">cudaOccupancyMaxPotentialBlockSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minGridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">);</span>

<span class="w">                    </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">                    </span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">                    </span><span class="n">error_buffer</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getCurve</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_condition&quot;</span><span class="p">).</span><span class="n">getDevicePtr</span><span class="p">(),</span>
<span class="w">                    </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getDeviceBuffer</span><span class="p">()),</span>
<span class="w">                    </span><span class="n">state_list_size</span><span class="p">,</span>
<span class="w">                    </span><span class="n">t_rng</span><span class="p">,</span>
<span class="w">                    </span><span class="n">scanFlag_agentDeath</span><span class="p">);</span>
<span class="w">                    </span><span class="n">gpuErrchkLaunch</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// RTC function</span>
<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">func_condition_identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_condition&quot;</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">// get instantiation</span>
<span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="n">jitify</span><span class="o">::</span><span class="n">experimental</span><span class="o">::</span><span class="n">KernelInstantiation</span><span class="o">&amp;</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getRTCInstantiation</span><span class="p">(</span><span class="n">func_condition_identifier</span><span class="p">);</span>
<span class="w">                    </span><span class="c1">// calculate the grid block size for main agent function</span>
<span class="w">                    </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">cu_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CUfunction</span><span class="p">)</span><span class="n">instance</span><span class="p">;</span>
<span class="w">                    </span><span class="n">cuOccupancyMaxPotentialBlockSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minGridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">cu_func</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">);</span>
<span class="w">                    </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">// launch the kernel</span>
<span class="w">                    </span><span class="n">CUresult</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">)).</span><span class="n">launch</span><span class="p">({</span>
<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">                        </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_buffer</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="w">                        </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_list_size</span><span class="p">)),</span>
<span class="w">                        </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_rng</span><span class="p">),</span>
<span class="w">                        </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scanFlag_agentDeath</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CUresult</span><span class="o">::</span><span class="n">CUDA_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">err_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">                        </span><span class="n">cuGetErrorString</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err_str</span><span class="p">);</span>
<span class="w">                        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;There was a problem launching the runtime agent function condition &#39;%s&#39;: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">rtc_func_condition_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">err_str</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">gpuErrchkLaunch</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Track stream index</span>
<span class="w">    </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Unmap agent memory, apply condition.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_des</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">agent_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">rtc_func_condition_name</span><span class="p">.</span><span class="n">empty</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">func_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_agent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;Agent function condition refers to expired agent.&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">unmap_range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;condition unmap &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">).</span><span class="n">c_str</span><span class="p">()};</span>
<span class="w">            </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Skip if no agents in the input state</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_list_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">            </span><span class="c1">// Error check after unmap vars</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">checkError</span><span class="p">(</span><span class="s">&quot;condition &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="c1">// Process agent function condition</span>
<span class="w">            </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">processFunctionCondition</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Increment the stream tracker.</span>
<span class="w">        </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Sum the total number of threads being launched in the layer</span>
<span class="w">    </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// for each func function - Loop through to do all mapping of agent and message variables</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_des</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">agent_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">func_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_agent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;Agent function refers to expired agent.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">map_range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;map&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">).</span><span class="n">c_str</span><span class="p">()};</span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_list_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Resize death flag array if necessary</span>
<span class="w">        </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">resize</span><span class="p">(</span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">AGENT_DEATH</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// check if a function has an input message</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">message_input</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">inpMessage_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">im</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">            </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAMessage</span><span class="p">(</span><span class="n">inpMessage_name</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Construct PBM here if required!!</span>
<span class="w">            </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">buildIndex</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span><span class="w">  </span><span class="c1">// This is synchronous.</span>
<span class="w">            </span><span class="c1">// Map variables after, as index building can swap arrays</span>
<span class="w">            </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">mapReadRuntimeVariables</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// check if a function has an output message</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">om</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">message_output</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">outpMessage_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">om</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">            </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAMessage</span><span class="p">(</span><span class="n">outpMessage_name</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Resize message list if required</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">existingMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">getTruncateMessageListFlag</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">getMessageCount</span><span class="p">();</span>
<span class="w">            </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">existingMessages</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="n">existingMessages</span><span class="p">);</span><span class="w">  </span><span class="c1">// This could have it&#39;s internal syncs delayed</span>
<span class="w">            </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">mapWriteRuntimeVariables</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">            </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">resize</span><span class="p">(</span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">MESSAGE_OUTPUT</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Zero the scan flag that will be written to</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">message_output_optional</span><span class="p">)</span>
<span class="w">                </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">zero_async</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">MESSAGE_OUTPUT</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// No Sync, any subsequent use should be in same stream</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// check if a function has an output agent</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">oa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">agent_output</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// This will act as a reserve word</span>
<span class="w">            </span><span class="c1">// which is added to variable hashes for agent creation on device</span>
<span class="w">            </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">output_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Map vars with curve (this allocates/requests enough new buffer space if an existing version is not available/suitable)</span>
<span class="w">            </span><span class="n">output_agent</span><span class="p">.</span><span class="n">mapNewRuntimeVariables_async</span><span class="p">(</span><span class="n">cuda_agent</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// No Sync, any subsequent use should be in same stream</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Configure runtime access of the functions variables within the FLAME_API object</span>
<span class="w">        </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">mapRuntimeVariables</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="n">instance_id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Zero the scan flag that will be written to</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">has_agent_death</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">zero_async</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">AGENT_DEATH</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// No Sync, any subsequent use should be in same stream</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Push function&#39;s RTC cache to device if using RTC</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">rtc_func_name</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rtc_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getRTCHeader</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Sync EnvManager&#39;s RTC cache with RTC header&#39;s cache</span>
<span class="w">            </span><span class="n">rtc_header</span><span class="p">.</span><span class="n">updateEnvCache</span><span class="p">(</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getHostBuffer</span><span class="p">(),</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getBufferLen</span><span class="p">());</span>
<span class="w">            </span><span class="c1">// Push RTC header&#39;s cache to device</span>
<span class="w">            </span><span class="n">rtc_header</span><span class="p">.</span><span class="n">updateDevice_async</span><span class="p">(</span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getRTCInstantiation</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">curve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getCurve</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">            </span><span class="n">curve</span><span class="p">.</span><span class="n">updateDevice_async</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// No sync, kernel launch should be in the same stream</span>

<span class="w">        </span><span class="c1">// Count total threads being launched</span>
<span class="w">        </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
<span class="w">        </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// If any kernel needs to be executed, do so, by checking the number of threads from before.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalThreads</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Ensure RandomManager is the correct size to accommodate all threads to be launched</span>
<span class="w">        </span><span class="n">detail</span><span class="o">::</span><span class="n">curandState</span><span class="w"> </span><span class="o">*</span><span class="n">d_rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">totalThreads</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// Total threads is now used to provide kernel launches an offset to thread-safe thread-index</span>
<span class="w">        </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// for each func function - Loop through to launch all agent functions</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_des</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">agent_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">func_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_agent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;Agent function refers to expired agent.&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">func_range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">).</span><span class="n">c_str</span><span class="p">()};</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">d_in_messagelist_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">d_out_messagelist_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">            </span><span class="kt">id_t</span><span class="w"> </span><span class="o">*</span><span class="n">d_agentOut_nextID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">agent_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">func_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// check if a function has an input message</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">message_input</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">inpMessage_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">im</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAMessage</span><span class="p">(</span><span class="n">inpMessage_name</span><span class="p">);</span>

<span class="w">                </span><span class="n">d_in_messagelist_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">getMetaDataDevicePtr</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// check if a function has an output message</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">om</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">message_output</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">outpMessage_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">om</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAMessage</span><span class="p">(</span><span class="n">outpMessage_name</span><span class="p">);</span>

<span class="w">                </span><span class="n">d_out_messagelist_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">getMetaDataDevicePtr</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// check if a function has agent output</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">oa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">agent_output</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">output_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">                </span><span class="n">d_agentOut_nextID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output_agent</span><span class="p">.</span><span class="n">getDeviceNextID</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">);</span>

<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_list_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The launch configurator returned block size</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">minGridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The minimum grid size needed to achieve the // maximum occupancy for a full device // launch</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// The actual grid size needed, based on input size</span>

<span class="w">            </span><span class="c1">// Agent function kernel wrapper args</span>
<span class="w">            </span><span class="n">detail</span><span class="o">::</span><span class="n">curandState</span><span class="w"> </span><span class="o">*</span><span class="n">t_rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_rng</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">totalThreads</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">scanFlag_agentDeath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">has_agent_death</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">Config</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">AGENT_DEATH</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">).</span><span class="n">d_ptrs</span><span class="p">.</span><span class="n">scan_flag</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">scanFlag_messageOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">Config</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">MESSAGE_OUTPUT</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">).</span><span class="n">d_ptrs</span><span class="p">.</span><span class="n">scan_flag</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">scanFlag_agentOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">.</span><span class="n">Scan</span><span class="p">().</span><span class="n">Config</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAScanCompaction</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">AGENT_OUTPUT</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">).</span><span class="n">d_ptrs</span><span class="p">.</span><span class="n">scan_flag</span><span class="p">;</span>
<span class="w">    </span><span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">error_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">getDevicePtr</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">    </span><span class="cp">#endif</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// compile time specified agent function launch</span>
<span class="w">                </span><span class="c1">// calculate the grid block size for main agent function</span>
<span class="w">                </span><span class="n">cudaOccupancyMaxPotentialBlockSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minGridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">);</span>
<span class="w">                </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>

<span class="w">                </span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">                    </span><span class="n">error_buffer</span><span class="p">,</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="w">                    </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getCurve</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">).</span><span class="n">getDevicePtr</span><span class="p">(),</span>
<span class="w">                    </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getDeviceBuffer</span><span class="p">()),</span>
<span class="w">                    </span><span class="n">d_agentOut_nextID</span><span class="p">,</span>
<span class="w">                    </span><span class="n">state_list_size</span><span class="p">,</span>
<span class="w">                    </span><span class="n">d_in_messagelist_metadata</span><span class="p">,</span>
<span class="w">                    </span><span class="n">d_out_messagelist_metadata</span><span class="p">,</span>
<span class="w">                    </span><span class="n">t_rng</span><span class="p">,</span>
<span class="w">                    </span><span class="n">scanFlag_agentDeath</span><span class="p">,</span>
<span class="w">                    </span><span class="n">scanFlag_messageOutput</span><span class="p">,</span>
<span class="w">                    </span><span class="n">scanFlag_agentOutput</span><span class="p">);</span>
<span class="w">                </span><span class="n">gpuErrchkLaunch</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="c1">// assume this is a runtime specified agent function</span>
<span class="w">                </span><span class="c1">// get instantiation</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">jitify</span><span class="o">::</span><span class="n">experimental</span><span class="o">::</span><span class="n">KernelInstantiation</span><span class="o">&amp;</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getRTCInstantiation</span><span class="p">(</span><span class="n">func_name</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// calculate the grid block size for main agent function</span>
<span class="w">                </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">cu_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CUfunction</span><span class="p">)</span><span class="n">instance</span><span class="p">;</span>
<span class="w">                </span><span class="n">cuOccupancyMaxPotentialBlockSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minGridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">cu_func</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">);</span>
<span class="w">                </span><span class="n">gridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// launch the kernel</span>
<span class="w">                </span><span class="n">CUresult</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">)).</span><span class="n">launch</span><span class="p">({</span>
<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">                    </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_buffer</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_agentOut_nextID</span><span class="p">),</span>
<span class="w">                    </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_list_size</span><span class="p">)),</span>
<span class="w">                    </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_in_messagelist_metadata</span><span class="p">)),</span>
<span class="w">                    </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_out_messagelist_metadata</span><span class="p">)),</span>
<span class="w">                    </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_rng</span><span class="p">)),</span>
<span class="w">                    </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scanFlag_agentDeath</span><span class="p">),</span>
<span class="w">                    </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scanFlag_messageOutput</span><span class="p">),</span>
<span class="w">                    </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scanFlag_agentOutput</span><span class="p">)});</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CUresult</span><span class="o">::</span><span class="n">CUDA_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">err_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">                    </span><span class="n">cuGetErrorString</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err_str</span><span class="p">);</span>
<span class="w">                    </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;There was a problem launching the runtime agent function &#39;%s&#39;: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">func_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">err_str</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">gpuErrchkLaunch</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">totalThreads</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">;</span>
<span class="w">            </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// for each func function - Loop through to un-map all agent and message variables</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_des</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">agent_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">func_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func_agent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgentFunc</span><span class="p">(</span><span class="s">&quot;Agent function refers to expired agent.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">unmap_range</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;unmap&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">).</span><span class="n">c_str</span><span class="p">()};</span>
<span class="w">        </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">func_agent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_list_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">getStateSize</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// If agent function wasn&#39;t executed, these are redundant</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// check if a function has an output message</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">om</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">message_output</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">outpMessage_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">om</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">                </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cuda_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAMessage</span><span class="p">(</span><span class="n">outpMessage_name</span><span class="p">);</span>
<span class="w">                </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">message_output_optional</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">),</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">);</span>
<span class="w">                </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">clearTruncateMessageListFlag</span><span class="p">();</span>
<span class="w">                </span><span class="n">cuda_message</span><span class="p">.</span><span class="n">setPBMConstructionRequiredFlag</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Process agent death (has agent death check is handled by the method)</span>
<span class="w">            </span><span class="c1">// This MUST occur before agent_output, as if agent_output triggers resize then scan_flag for death will be purged</span>
<span class="w">            </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">processDeath</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>

<span class="w">            </span><span class="c1">// Process agent state transition (Longer term merge this with process death?)</span>
<span class="w">            </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">transitionState</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">,</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">end_state</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Process agent function condition</span>
<span class="w">        </span><span class="n">cuda_agent</span><span class="p">.</span><span class="n">clearFunctionCondition</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// If agent function wasn&#39;t executed, these are redundant</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_list_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// check if a function has an output agent</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">oa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">agent_output</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// This will act as a reserve word</span>
<span class="w">                </span><span class="c1">// which is added to variable hashes for agent creation on device</span>
<span class="w">                </span><span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">output_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Scatter the agent birth</span>
<span class="w">                </span><span class="n">output_agent</span><span class="p">.</span><span class="n">scatterNew</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">,</span><span class="w"> </span><span class="n">state_list_size</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">                </span><span class="n">output_agent</span><span class="p">.</span><span class="n">releaseNewBuffer</span><span class="p">(</span><span class="o">*</span><span class="n">func_des</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">            </span><span class="c1">// Error check after unmap vars</span>
<span class="w">            </span><span class="c1">// This means that curve is cleaned up before we throw exception (mostly prevents curve being polluted if we catch and handle errors)</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">checkError</span><span class="p">(</span><span class="n">func_des</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">++</span><span class="n">streamIdx</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Synchronise to ensure that device memory is in a goood state prior to host layer functions? This can potentially be removed</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">synchronizeAllStreams</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Execute the host functions.</span>
<span class="w">    </span><span class="n">layerHostFunctions</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span><span class="w"> </span><span class="n">layerIndex</span><span class="p">);</span>

<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">    </span><span class="c1">// Reset macro-environment read-write flags</span>
<span class="w">    </span><span class="c1">// Note this does not synchronise threads, it relies on synchronizeAllStreams() post host fns</span>
<span class="w">    </span><span class="n">macro_env</span><span class="p">.</span><span class="n">resetFlagsAsync</span><span class="p">(</span><span class="n">streams</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="c1">// Synchronise  after the host layer functions to ensure that the device is up to date? This can potentially be removed.</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">synchronizeAllStreams</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">layerHostFunctions</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">LayerData</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">layer</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">layerIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::stepHostFunctions&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="c1">// Execute all host functions attached to layer</span>
<span class="w">    </span><span class="c1">// TODO: Concurrency?</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">host_api</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stepFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">host_functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">hostfn_range</span><span class="p">{</span><span class="s">&quot;hostFunc&quot;</span><span class="p">};</span>
<span class="w">        </span><span class="n">stepFn</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Execute all host function callbacks attached to layer</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stepFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">host_functions_callbacks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">hostfncallback_range</span><span class="p">{</span><span class="s">&quot;hostFunc_swig&quot;</span><span class="p">};</span>
<span class="w">        </span><span class="n">stepFn</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// If we have host layer functions, we might have host agent creation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">host_functions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">host_functions_callbacks</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Sync any device vectors, before performing host agent creation</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ca</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ca</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">resetPopulationVecs</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// @todo - What is the most appropriate stream to use here?</span>
<span class="w">        </span><span class="n">processHostAgentCreation</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">stepStepFunctions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::step::StepFunctions&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="c1">// Execute step functions</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stepFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">stepFunctions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">step_range</span><span class="p">{</span><span class="s">&quot;stepFunc&quot;</span><span class="p">};</span>
<span class="w">        </span><span class="n">stepFn</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Execute step function callbacks</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stepFn</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">stepFunctionCallbacks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">callback_range</span><span class="p">{</span><span class="s">&quot;stepFunc_swig&quot;</span><span class="p">};</span>
<span class="w">        </span><span class="n">stepFn</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// If we have step functions, we might have host agent creation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">stepFunctions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">stepFunctionCallbacks</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Sync any device vectors, before performing host agent creation</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ca</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ca</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">resetPopulationVecs</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">processHostAgentCreation</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">stepExitConditions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::stepExitConditions&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="c1">// Track if any exit conditions were successful. Use this to control return code and skipsteps.</span>
<span class="w">    </span><span class="c1">// early returning makes timing/stepCounter logic more complicated.</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">exitConditionExit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Execute exit conditions</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exitCdns</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">exitConditions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCdns</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateBuffers</span><span class="p">(</span><span class="n">step_count</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="cp">#endif</span>
<span class="w">            </span><span class="c1">// Set the flag, and bail out of the exit condition loop.</span>
<span class="w">            </span><span class="n">exitConditionExit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Execute exit condition callbacks</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exitConditionExit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exitCdns</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">exitConditionCallbacks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCdns</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">host_api</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateBuffers</span><span class="p">(</span><span class="n">step_count</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="cp">#endif</span>
<span class="w">                </span><span class="c1">// Set the flag, and bail out of the exit condition loop.</span>
<span class="w">                </span><span class="n">exitConditionExit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// No need for this if any exit conditions passed.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exitConditionExit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// If we have exit conditions functions, we might have host agent creation</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">exitConditions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">exitConditionCallbacks</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">processHostAgentCreation</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateBuffers</span><span class="p">(</span><span class="n">step_count</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">exitConditionExit</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">simulate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::simulate&quot;</span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Ensure there is work to do.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">agent_map</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCudaAgentMapSize</span><span class="p">(</span><span class="s">&quot;Simulation has no agents, in CUDASimulation::simulate().&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Ensure singletons have been initialised</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Create the event timing object, using an appropriate timer implementation.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">simulationTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDriverAppropriateTimer</span><span class="p">(</span><span class="n">getCUDAConfig</span><span class="p">().</span><span class="n">is_ensemble</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getCUDAConfig</span><span class="p">().</span><span class="n">is_submodel</span><span class="p">);</span>
<span class="w">    </span><span class="n">simulationTimer</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Create as many streams as required</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMaximumLayerWidth</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">createStreams</span><span class="p">(</span><span class="n">nStreams</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Init any unset agent IDs</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">assignAgentIDs</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Reinitialise any unmapped agent variables</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">submodel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">streamIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">initUnmappedVars</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">streamIdx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamIdx</span><span class="p">));</span>
<span class="w">            </span><span class="n">streamIdx</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Reset the class&#39; elapsed time value.</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsSimulation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.f</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Execute init functions</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">initFunctions</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Reset and log initial state to step log 0</span>
<span class="w">    </span><span class="n">resetLog</span><span class="p">();</span>
<span class="w">    </span><span class="n">processStepLog</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsRTCInitialisation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsInitFunctions</span><span class="p">);</span>

<span class="w">    </span><span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">    </span><span class="c1">// Pre step-loop visualisation update</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateBuffers</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">visualiser</span><span class="o">::</span><span class="n">ModelVis</span><span class="w"> </span><span class="n">mv</span><span class="p">(</span><span class="n">visualisation</span><span class="p">,</span><span class="w"> </span><span class="n">isSWIG</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#endif</span>

<span class="w">    </span><span class="c1">// Run the required number of simulation steps.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Run the step</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">continueSimulation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">continueSimulation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>

<span class="w">        </span><span class="c1">// Special case, if steps == 0 and visualisation has been closed</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">visualisation</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mv</span><span class="p">.</span><span class="n">isRunning</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mv</span><span class="p">.</span><span class="n">join</span><span class="p">();</span><span class="w">  </span><span class="c1">// Vis exists in separate thread, make sure it has actually exited</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Exit functions</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">exitFunctions</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Sync visualistaion after the exit functions</span>
<span class="w">    </span><span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateBuffers</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cp">#endif</span>

<span class="w">    </span><span class="c1">// Record, store and output the elapsed simulation time</span>
<span class="w">    </span><span class="n">simulationTimer</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="w">    </span><span class="n">elapsedSecondsSimulation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulationTimer</span><span class="o">-&gt;</span><span class="n">getElapsedSeconds</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">timing</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Verbose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Resolution is 0.5 microseconds, so print to 1 us.</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Total Processing time: %.6f s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">elapsedSecondsSimulation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">processExitLog</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Send Telemetry if not submodel</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">telemetry</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">getCUDAConfig</span><span class="p">().</span><span class="n">is_submodel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Generate some payload items</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">payload_items</span><span class="p">;</span>
<span class="w">        </span><span class="n">payload_items</span><span class="p">[</span><span class="s">&quot;GPUDevices&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">compute_capability</span><span class="o">::</span><span class="n">getDeviceName</span><span class="p">(</span><span class="n">deviceInitialised</span><span class="p">);</span>
<span class="w">        </span><span class="n">payload_items</span><span class="p">[</span><span class="s">&quot;SimTime(s)&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">elapsedSecondsSimulation</span><span class="p">);</span>
<span class="w">        </span><span class="cp">#if defined(__CUDACC_VER_MAJOR__) &amp;&amp; defined(__CUDACC_VER_MINOR__) &amp;&amp; defined(__CUDACC_VER_BUILD__)</span>
<span class="w">            </span><span class="n">payload_items</span><span class="p">[</span><span class="s">&quot;NVCCVersion&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">__CUDACC_VER_MAJOR__</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">__CUDACC_VER_MINOR__</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">__CUDACC_VER_BUILD__</span><span class="p">);</span>
<span class="w">        </span><span class="cp">#endif</span>
<span class="w">        </span><span class="c1">// generate telemtry data</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Telemetry</span><span class="o">::</span><span class="n">generateData</span><span class="p">(</span><span class="s">&quot;simulation-run&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">payload_items</span><span class="p">,</span><span class="w"> </span><span class="n">isSWIG</span><span class="p">);</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">telemetrySuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Telemetry</span><span class="o">::</span><span class="n">sendData</span><span class="p">(</span><span class="n">telemetry_data</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// If verbose, print either a successful send, or a misc warning.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Verbose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">telemetrySuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Telemetry packet sent to &#39;%s&#39; json was: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Telemetry</span><span class="o">::</span><span class="n">TELEMETRY_ENDPOINT</span><span class="p">,</span><span class="w"> </span><span class="n">telemetry_data</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Warning: Usage statistics for CUDASimulation failed to send.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Encourage users who have opted out to opt back in, unless suppressed.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">verbosity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Verbosity</span><span class="o">::</span><span class="n">Quiet</span><span class="p">))</span>
<span class="w">            </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Telemetry</span><span class="o">::</span><span class="n">encourageUsage</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Export logs</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">step_log_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="w">        </span><span class="n">exportLog</span><span class="p">(</span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">step_log_file</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">step_log_config</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">step_log_config</span><span class="o">-&gt;</span><span class="n">log_timing</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">exit_log_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="w">        </span><span class="n">exportLog</span><span class="p">(</span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">exit_log_file</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">exit_log_config</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">exit_log_config</span><span class="o">-&gt;</span><span class="n">log_timing</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">common_log_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="w">        </span><span class="n">exportLog</span><span class="p">(</span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">common_log_file</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">step_log_config</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">step_log_config</span><span class="o">-&gt;</span><span class="n">log_timing</span><span class="p">,</span><span class="w"> </span><span class="n">exit_log_config</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">exit_log_config</span><span class="o">-&gt;</span><span class="n">log_timing</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">simulate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">RunPlan</span><span class="o">&amp;</span><span class="w"> </span><span class="n">plan</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Validate that RunPlan is for same ModelDesc</span>
<span class="w">    </span><span class="c1">// RunPlan only holds a copy of env, so we must compare those</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">plan</span><span class="p">.</span><span class="n">environment</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidArgument</span><span class="p">(</span><span class="s">&quot;RunPlan&#39;s associated environment does not match the ModelDescription&#39;s environment, &quot;</span>
<span class="w">        </span><span class="s">&quot;in CUDASimulation::simulate(RunPlan)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Backup config</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">t_random_seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">t_steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Temp override config</span>
<span class="w">    </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plan</span><span class="p">.</span><span class="n">getSteps</span><span class="p">();</span>
<span class="w">    </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plan</span><span class="p">.</span><span class="n">getRandomSimulationSeed</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Ensure singletons have been initialised (so env actually exists in mgr)</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Override environment properties</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ovrd</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">plan</span><span class="p">.</span><span class="n">property_overrides</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">setPropertyDirect</span><span class="p">(</span><span class="n">ovrd</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ovrd</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">ptr</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Call regular simulate</span>
<span class="w">    </span><span class="n">simulate</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Reset config</span>
<span class="w">    </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_random_seed</span><span class="p">;</span>
<span class="w">    </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_steps</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">reset</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">submodelReset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Reset step counter</span>
<span class="w">    </span><span class="n">resetStepCounter</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">singletonsInitialised</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Reset environment properties</span>
<span class="w">        </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">resetModel</span><span class="p">(</span><span class="o">*</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Reseed random, unless performing submodel reset</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">submodelReset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">reseed</span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cull agents</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">submodel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Submodels only want to reset unmapped states, otherwise they will break parent model</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cullUnmappedStates</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cullAllStates</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cull messagelists</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">message_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setMessageCount</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setTruncateMessageListFlag</span><span class="p">();</span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setPBMConstructionRequiredFlag</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="c1">// Trigger reset in all submodels, propagation is not necessary when performing submodel reset</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">submodelReset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">submodel_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Reset any timing data.</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsSimulation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.f</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">setPopulationData</span><span class="p">(</span><span class="n">AgentVector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">population</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">state_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Ensure singletons have been initialised</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::setPopulationData()&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">population</span><span class="p">.</span><span class="n">getAgentName</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgent</span><span class="p">(</span><span class="s">&quot;Agent &#39;%s&#39; was not found, &quot;</span>
<span class="w">            </span><span class="s">&quot;in CUDASimulation::setPopulationData()&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">population</span><span class="p">.</span><span class="n">getAgentName</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// This call hierarchy validates agent desc matches and state is valid</span>
<span class="w">    </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">setPopulationData</span><span class="p">(</span><span class="n">population</span><span class="p">,</span><span class="w"> </span><span class="n">state_name</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w">  </span><span class="c1">// Streamid shouldn&#39;t matter here</span>
<span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateBuffers</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaDeviceSynchronize</span><span class="p">());</span>
<span class="w">    </span><span class="n">agent_ids_have_init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getPopulationData</span><span class="p">(</span><span class="n">AgentVector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">population</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">state_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Ensure singletons have been initialised</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::getPopulationData()&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaDeviceSynchronize</span><span class="p">());</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">population</span><span class="p">.</span><span class="n">getAgentName</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidAgent</span><span class="p">(</span><span class="s">&quot;Agent &#39;%s&#39; was not found, &quot;</span>
<span class="w">            </span><span class="s">&quot;in CUDASimulation::setPopulationData()&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">population</span><span class="p">.</span><span class="n">getAgentName</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// This call hierarchy validates agent desc matches and state is valid</span>
<span class="w">    </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getPopulationData</span><span class="p">(</span><span class="n">population</span><span class="p">,</span><span class="w"> </span><span class="n">state_name</span><span class="p">);</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaDeviceSynchronize</span><span class="p">());</span>
<span class="p">}</span>
<span class="n">detail</span><span class="o">::</span><span class="n">CUDAAgent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getCUDAAgent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">agent_name</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CUDAAgentMap</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">it</span><span class="p">;</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">agent_name</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCudaAgent</span><span class="p">(</span><span class="s">&quot;CUDA agent (&#39;%s&#39;) not found, in CUDASimulation::getCUDAAgent().&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">agent_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">detail</span><span class="o">::</span><span class="n">CUDAMessage</span><span class="o">&amp;</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getCUDAMessage</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">message_name</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CUDAMessageMap</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">it</span><span class="p">;</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">message_name</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">message_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCudaMessage</span><span class="p">(</span><span class="s">&quot;CUDA message (&#39;%s&#39;) not found, in CUDASimulation::getCUDAMessage().&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">message_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">setStepLog</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">StepLoggingConfig</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stepConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Validate ModelDescription matches</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">stepConfig</span><span class="p">.</span><span class="n">model</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">*</span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidArgument</span><span class="p">(</span><span class="s">&quot;Model descriptions attached to LoggingConfig and CUDASimulation do not match, in CUDASimulation::setStepLog()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Set internal config</span>
<span class="w">    </span><span class="n">step_log_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">StepLoggingConfig</span><span class="o">&gt;</span><span class="p">(</span><span class="n">stepConfig</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">setExitLog</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">LoggingConfig</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exitConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Validate ModelDescription matches</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">exitConfig</span><span class="p">.</span><span class="n">model</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">*</span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidArgument</span><span class="p">(</span><span class="s">&quot;Model descriptions attached to LoggingConfig and CUDASimulation do not match, in CUDASimulation::setExitLog()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Set internal config</span>
<span class="w">    </span><span class="n">exit_log_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">LoggingConfig</span><span class="o">&gt;</span><span class="p">(</span><span class="n">exitConfig</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">checkArgs_derived</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get arg as lowercase</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">arg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="p">[](</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">use_facet</span><span class="o">&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ctype</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">locale</span><span class="p">()).</span><span class="n">tolower</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// -device &lt;uint&gt;, Uses the specified cuda device, defaults to 0</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">arg</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;--device&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">printHelp_derived</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">line_fmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;%-18s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;CUDA Model Optional Arguments:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="n">line_fmt</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-d, --device&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GPU index&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">applyConfig_derived</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;applyConfig_derived&quot;</span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Handle console_mode</span>
<span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">visualiser</span><span class="o">::</span><span class="n">ModelVis</span><span class="w"> </span><span class="nf">mv</span><span class="p">(</span><span class="n">visualisation</span><span class="p">,</span><span class="w"> </span><span class="n">isSWIG</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">console_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mv</span><span class="p">.</span><span class="n">deactivate</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateRandomSeed</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>


<span class="w">    </span><span class="n">cudaError_t</span><span class="w"> </span><span class="n">cudaStatus</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">device_count</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// default device</span>
<span class="w">    </span><span class="n">cudaStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaGetDeviceCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_count</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCUDAdevice</span><span class="p">(</span><span class="s">&quot;Error finding CUDA devices!  Do you have a CUDA-capable GPU installed?&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCUDAdevice</span><span class="p">(</span><span class="s">&quot;Error no CUDA devices found!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Select device</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">device_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCUDAdevice</span><span class="p">(</span><span class="s">&quot;Error setting CUDA device to &#39;%d&#39;, only %d available!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">device_count</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deviceInitialised</span><span class="w"> </span><span class="o">!=-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">deviceInitialised</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCUDAdevice</span><span class="p">(</span><span class="s">&quot;Unable to set CUDA device to &#39;%d&#39; after the CUDASimulation has already initialised on device &#39;%d&#39;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">deviceInitialised</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check the compute capability of the device, throw an exception if not valid for the executable.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">detail</span><span class="o">::</span><span class="n">compute_capability</span><span class="o">::</span><span class="n">checkComputeCapability</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">min_cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">compute_capability</span><span class="o">::</span><span class="n">minimumCompiledComputeCapability</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">compute_capability</span><span class="o">::</span><span class="n">getComputeCapability</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">));</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCUDAComputeCapability</span><span class="p">(</span><span class="s">&quot;Error application compiled for CUDA Compute Capability %d and above. Device %u is compute capability %d. Rebuild for SM_%d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">min_cc</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cudaStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCUDAdevice</span><span class="p">(</span><span class="s">&quot;Unknown error setting CUDA device to &#39;%d&#39;. (%d available)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">device_count</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Call cudaFree to initialise the context early</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="k">nullptr</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Get the unique ID of the current cuda context, to prevent unsafe stream destruction post flamegpu::cleanup for CUDA 12+</span>
<span class="cp">#if __CUDACC_VER_MAJOR__ &gt;= 12</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">cudaContextID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">cuda</span><span class="o">::</span><span class="n">cuGetCurrentContextUniqueID</span><span class="p">();</span>
<span class="cp">#endif  </span><span class="c1">// __CUDACC_VER_MAJOR__ &gt;= 12</span>

<span class="w">    </span><span class="c1">// Apply changes to submodels</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">submodel_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// We&#39;re not actually going to use this value, but it might be useful there later</span>
<span class="w">        </span><span class="c1">// Calling apply config a second time would reinit GPU, which might clear existing gpu allocations etc</span>
<span class="w">        </span><span class="n">sm</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">CUDAConfig</span><span class="p">().</span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Initialise singletons once a device has been selected.</span>
<span class="w">    </span><span class="n">initialiseSingletons</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// We init Random through submodel hierarchy after singletons</span>
<span class="w">    </span><span class="n">reseed</span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">reseed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">seed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seed</span><span class="p">;</span>
<span class="w">    </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">reseed</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Propagate to submodels</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">submodel_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Pass random seed on to submodels</span>
<span class="w">        </span><span class="n">sm</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">reseed</span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">23</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Mutate seed</span>
<span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">initialiseSingletons</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Only do this once.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">singletonsInitialised</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// If the device has not been specified, also check the compute capability is OK</span>
<span class="w">        </span><span class="c1">// Check the compute capability of the device, throw an exception if not valid for the executable.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">detail</span><span class="o">::</span><span class="n">compute_capability</span><span class="o">::</span><span class="n">checkComputeCapability</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">min_cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">compute_capability</span><span class="o">::</span><span class="n">minimumCompiledComputeCapability</span><span class="p">();</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">compute_capability</span><span class="o">::</span><span class="n">getComputeCapability</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">));</span>
<span class="w">            </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidCUDAComputeCapability</span><span class="p">(</span><span class="s">&quot;Error application compiled for CUDA Compute Capability %d and above. Device %u is compute capability %d. Rebuild for SM_%d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">min_cc</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaGetDevice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deviceInitialised</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// Get references to all required singleton and store in the instance.</span>
<span class="w">        </span><span class="n">singletons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Singletons</span><span class="p">((</span><span class="o">!</span><span class="n">submodel</span><span class="p">)</span><span class="o">?</span>
<span class="w">            </span><span class="n">detail</span><span class="o">::</span><span class="n">EnvironmentManager</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="o">*</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">            </span><span class="n">detail</span><span class="o">::</span><span class="n">EnvironmentManager</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="o">*</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">mastermodel</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">submodel</span><span class="o">-&gt;</span><span class="n">subenvironment</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Reinitialise random for this simulation instance</span>
<span class="w">        </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">reseed</span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="p">);</span>

<span class="w">        </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Pass created RandomManager to host api</span>
<span class="w">        </span><span class="n">host_api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">HostAPI</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">agentOffsets</span><span class="p">,</span><span class="w"> </span><span class="n">agentData</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">macro_env</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream_0</span><span class="p">);</span><span class="w">  </span><span class="c1">// Host fns are currently all serial</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">message_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cm</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream_0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Populate the environment properties</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">submodel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">macro_env</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">stream_0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">macro_env</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="o">*</span><span class="n">submodel</span><span class="o">-&gt;</span><span class="n">subenvironment</span><span class="p">,</span><span class="w"> </span><span class="n">mastermodel</span><span class="o">-&gt;</span><span class="n">macro_env</span><span class="p">,</span><span class="w"> </span><span class="n">stream_0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Propagate singleton init to submodels</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">submodel_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sm</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">initialiseSingletons</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Store the WDDM/TCC driver mode status, for timer class decisions. Result is cached in the anon namespace to avoid multiple queries</span>
<span class="w">        </span><span class="n">deviceUsingWDDM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">wddm</span><span class="o">::</span><span class="n">deviceIsWDDM</span><span class="p">();</span>

<span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visualisation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">updateRandomSeed</span><span class="p">();</span><span class="w">  </span><span class="c1">// Incase user hasn&#39;t triggered applyConfig()</span>
<span class="w">            </span><span class="n">visualisation</span><span class="o">-&gt;</span><span class="n">registerEnvProperties</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">singletonsInitialised</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaGetDevice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">deviceInitialised</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">CUDAError</span><span class="p">(</span><span class="s">&quot;CUDASimulation initialised on device %d, but stepped on device %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">deviceInitialised</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Populate the environment properties</span>
<span class="w">    </span><span class="n">initEnvironmentMgr</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Ensure there are enough streams to execute the layer.</span>
<span class="w">    </span><span class="c1">// Taking into consideration if in-layer concurrency is disabled or not.</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMaximumLayerWidth</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">createStreams</span><span class="p">(</span><span class="n">nStreams</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ensure RTC is set up.</span>
<span class="w">    </span><span class="n">initialiseRTC</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">initialiseRTC</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Only do this once.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rtcInitialised</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::initialiseRTC&quot;</span><span class="p">};</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">Timer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rtcTimer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">SteadyClockTimer</span><span class="p">());</span>
<span class="w">        </span><span class="n">rtcTimer</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Build any RTC functions</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">-&gt;</span><span class="n">agents</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// iterate agents and then agent functions to find any rtc functions or function conditions</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">a_it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mf</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">it_f</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">mf</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it_f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// check rtc source to see if this is a RTC function</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">rtc_source</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// create CUDA agent RTC function by calling addInstantitateRTCFunction on CUDAAgent with AgentFunctionData</span>
<span class="w">                    </span><span class="n">a_it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">addInstantitateRTCFunction</span><span class="p">(</span><span class="o">*</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">macro_env</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Init curve for non-rtc functions</span>
<span class="w">                    </span><span class="n">a_it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">addInstantitateFunction</span><span class="p">(</span><span class="o">*</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">macro_env</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// check rtc source to see if the function condition is an rtc condition</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">rtc_condition_source</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// create CUDA agent RTC function condition by calling addInstantitateRTCFunction on CUDAAgent with AgentFunctionData</span>
<span class="w">                    </span><span class="n">a_it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">addInstantitateRTCFunction</span><span class="p">(</span><span class="o">*</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">macro_env</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Init curve for non-rtc function conditionss</span>
<span class="w">                    </span><span class="n">a_it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">addInstantitateFunction</span><span class="p">(</span><span class="o">*</span><span class="n">it_f</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">macro_env</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">rtcInitialised</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Record, store and output the elapsed time of the step.</span>
<span class="w">        </span><span class="n">rtcTimer</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsRTCInitialisation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtcTimer</span><span class="o">-&gt;</span><span class="n">getElapsedSeconds</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getSimulationConfig</span><span class="p">().</span><span class="n">timing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RTC Initialisation Processing time: %.6f s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsRTCInitialisation</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">CUDASimulation</span><span class="o">::</span><span class="n">Config</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">CUDAConfig</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">const</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">Config</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getCUDAConfig</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef FLAMEGPU_VISUALISATION</span>
<span class="n">visualiser</span><span class="o">::</span><span class="n">ModelVis</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getVisualisation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">visualisation</span><span class="p">)</span>
<span class="w">        </span><span class="n">visualisation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">visualiser</span><span class="o">::</span><span class="n">ModelVisData</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">visualiser</span><span class="o">::</span><span class="n">ModelVis</span><span class="p">(</span><span class="n">visualisation</span><span class="p">,</span><span class="w"> </span><span class="n">isSWIG</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getStepCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">step_count</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">resetStepCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">step_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">initOffsetsAndMap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getModelDescription</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Build offsets</span>
<span class="w">    </span><span class="n">agentOffsets</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">agents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">agentOffsets</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">agent</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">VarOffsetStruct</span><span class="p">(</span><span class="n">agent</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Build data</span>
<span class="w">    </span><span class="n">agentData</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">agents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">AgentDataBufferStateMap</span><span class="w"> </span><span class="n">agent_states</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="n">state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">)</span>
<span class="w">            </span><span class="n">agent_states</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">AgentDataBuffer</span><span class="p">());</span>
<span class="w">        </span><span class="n">agentData</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">agent</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">agent_states</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">processHostAgentCreation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">streamId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">t_bufflen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">t_buff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dt_buff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// For each agent type</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agentData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// We need size of agent</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">VarOffsetStruct</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agentOffsets</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">agent</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// For each state within the agent</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// If the buffer has data</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offsets</span><span class="p">.</span><span class="n">totalSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">                </span><span class="p">{</span><span class="w">  </span><span class="c1">// Ensure we have enough temp memory</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_req</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">t_bufflen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_buff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">free</span><span class="p">(</span><span class="n">t_buff</span><span class="p">);</span>
<span class="w">                            </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">flamegpu</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">cuda</span><span class="o">::</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">dt_buff</span><span class="p">));</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                        </span><span class="n">t_buff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="n">size_req</span><span class="p">));</span>
<span class="w">                        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dt_buff</span><span class="p">,</span><span class="w"> </span><span class="n">size_req</span><span class="p">));</span>
<span class="w">                        </span><span class="n">t_bufflen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size_req</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// Copy buffer memory into a single block</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">t_buff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">offsets</span><span class="p">.</span><span class="n">totalSize</span><span class="p">),</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span><span class="p">.</span><span class="n">totalSize</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// Copy t_buff to device</span>
<span class="w">                </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="n">dt_buff</span><span class="p">,</span><span class="w"> </span><span class="n">t_buff</span><span class="p">,</span><span class="w"> </span><span class="n">size_req</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamId</span><span class="p">)));</span>
<span class="w">                </span><span class="c1">// Scatter to device</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cudaagent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agent_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">agent</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
<span class="w">                </span><span class="n">cudaagent</span><span class="o">-&gt;</span><span class="n">scatterHostCreation</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span><span class="w"> </span><span class="n">dt_buff</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">streamId</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getStream</span><span class="p">(</span><span class="n">streamId</span><span class="p">));</span>
<span class="w">                </span><span class="c1">// Clear buffer</span>
<span class="w">                </span><span class="n">state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Release temp memory</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_buff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">t_buff</span><span class="p">);</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">flamegpu</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">cuda</span><span class="o">::</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">dt_buff</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">incrementStepCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">step_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">setProperty</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;_stepCount&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">step_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getElapsedTimeSimulation</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get the value</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsSimulation</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getElapsedTimeInitFunctions</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get the value</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsInitFunctions</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getElapsedTimeExitFunctions</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get the value</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsExitFunctions</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">double</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getElapsedTimeRTCInitialisation</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get the value</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsRTCInitialisation</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getElapsedTimeSteps</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// returns a copy of the timing vector, to avoid mutabililty issues. This should not be called in a performacne intensive part of the application.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rtn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getElapsedTimeStep</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">step</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">step</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">OutOfBoundsException</span><span class="p">(</span><span class="s">&quot;getElapsedTimeStep out of bounds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">elapsedSecondsPerStep</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">step</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">initEnvironmentMgr</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">singletons</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">UnknownInternalError</span><span class="p">(</span><span class="s">&quot;CUDASimulation::initEnvironmentMgr() called before singletons member initialised.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Set any properties loaded from file during arg parse stage</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prop</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">env_init</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidEnvProperty</span><span class="p">(</span><span class="s">&quot;Environment init data contains unexpected environment property &#39;%s&#39;, &quot;</span>
<span class="w">                </span><span class="s">&quot;in CUDASimulation::initEnvironmentMgr()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidEnvProperty</span><span class="p">(</span><span class="s">&quot;Environment init data contains environment property &#39;%s&#39; with type mismatch &#39;%s&#39; != &#39;%s&#39;, &quot;</span>
<span class="w">                </span><span class="s">&quot;this should have been caught during file parsing, &quot;</span>
<span class="w">                </span><span class="s">&quot;in CUDASimulation::initEnvironmentMgr()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">elements</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">THROW</span><span class="w"> </span><span class="n">exception</span><span class="o">::</span><span class="n">InvalidEnvProperty</span><span class="p">(</span><span class="s">&quot;Environment init data contains environment property &#39;%s&#39; with type length mismatch &#39;%u&#39; != &#39;%u&#39;, &quot;</span>
<span class="w">                </span><span class="s">&quot;this should have been caught during file parsing, &quot;</span>
<span class="w">                </span><span class="s">&quot;in CUDASimulation::initEnvironmentMgr()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">elements</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">setPropertyDirect</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">ptr</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Clear init</span>
<span class="w">    </span><span class="n">env_init</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">resetLog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Track previous device id, so we can avoid costly request for device properties if not required</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">previous_device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">exit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExitLogFrame</span><span class="p">();</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">random_seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimulationConfig</span><span class="p">().</span><span class="n">random_seed</span><span class="p">;</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">step_log_frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step_log_config</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">step_log_config</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">device_name</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">CUDAConfig</span><span class="p">().</span><span class="n">device_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">previous_device_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaDeviceProp</span><span class="w"> </span><span class="n">d_props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaGetDeviceProperties</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_props</span><span class="p">,</span><span class="w"> </span><span class="n">CUDAConfig</span><span class="p">().</span><span class="n">device_id</span><span class="p">));</span>
<span class="w">        </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">device_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_props</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="n">previous_device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CUDAConfig</span><span class="p">().</span><span class="n">device_id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaDeviceGetAttribute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">device_cc_major</span><span class="p">,</span><span class="w"> </span><span class="n">cudaDevAttrComputeCapabilityMajor</span><span class="p">,</span><span class="w"> </span><span class="n">CUDAConfig</span><span class="p">().</span><span class="n">device_id</span><span class="p">));</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaDeviceGetAttribute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">device_cc_minor</span><span class="p">,</span><span class="w">  </span><span class="n">cudaDevAttrComputeCapabilityMinor</span><span class="p">,</span><span class="w"> </span><span class="n">CUDAConfig</span><span class="p">().</span><span class="n">device_id</span><span class="p">));</span>
<span class="w">    </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaRuntimeGetVersion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">cuda_version</span><span class="p">));</span>
<span class="cp">#if !defined(FLAMEGPU_SEATBELTS) || FLAMEGPU_SEATBELTS</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">seatbelts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">seatbelts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">performance_specs</span><span class="p">.</span><span class="n">flamegpu_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VERSION_FULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">processStepLog</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">step_time_seconds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">step_log_config</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">step_count</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">step_log_config</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Iterate members of step log to build the step log frame</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;</span><span class="w"> </span><span class="n">environment_log</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prop_name</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">step_log_config</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Fetch the named environment prop</span>
<span class="w">        </span><span class="n">environment_log</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">prop_name</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getPropertyAny</span><span class="p">(</span><span class="n">prop_name</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">util</span><span class="o">::</span><span class="n">StringPair</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">LoggingConfig</span><span class="o">::</span><span class="n">NameReductionFn</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">agents_log</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">step_log_config</span><span class="o">-&gt;</span><span class="n">agents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Create the named sub map</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_state</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_state</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<span class="w">        </span><span class="n">HostAgentAPI</span><span class="w"> </span><span class="n">host_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host_api</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span><span class="w"> </span><span class="n">agent_state</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent_state_log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agents_log</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">name_state</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">LoggingConfig</span><span class="o">::</span><span class="n">NameReductionFn</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">UINT_MAX</span><span class="p">)).</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Log individual variable reductions</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name_reduction</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">name_state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Perform the corresponding reduction</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_reduction</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="n">host_agent</span><span class="p">,</span><span class="w"> </span><span class="n">name_reduction</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Store the result</span>
<span class="w">            </span><span class="n">agent_state_log</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">name_reduction</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Log count of agents in state</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name_state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">agent_state_log</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host_api</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span><span class="w"> </span><span class="n">agent_state</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Append to step log</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">StepLogFrame</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">environment_log</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">agents_log</span><span class="p">),</span><span class="w"> </span><span class="n">step_count</span><span class="p">));</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">step_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step_time_seconds</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">processExitLog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exit_log_config</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Iterate members of step log to build the step log frame</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;</span><span class="w"> </span><span class="n">environment_log</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prop_name</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">exit_log_config</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Fetch the named environment prop</span>
<span class="w">        </span><span class="n">environment_log</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">prop_name</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="n">getPropertyAny</span><span class="p">(</span><span class="n">prop_name</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">util</span><span class="o">::</span><span class="n">StringPair</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">LoggingConfig</span><span class="o">::</span><span class="n">NameReductionFn</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">agents_log</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">exit_log_config</span><span class="o">-&gt;</span><span class="n">agents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Create the named sub map</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_state</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_state</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<span class="w">        </span><span class="n">HostAgentAPI</span><span class="w"> </span><span class="n">host_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host_api</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span><span class="w"> </span><span class="n">agent_state</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent_state_log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agents_log</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">name_state</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">LoggingConfig</span><span class="o">::</span><span class="n">NameReductionFn</span><span class="p">,</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">UINT_MAX</span><span class="p">)).</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Log individual variable reductions</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name_reduction</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">name_state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Perform the corresponding reduction</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_reduction</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="n">host_agent</span><span class="p">,</span><span class="w"> </span><span class="n">name_reduction</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Store the result</span>
<span class="w">            </span><span class="n">agent_state_log</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">name_reduction</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Log count of agents in state</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name_state</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">agent_state_log</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host_api</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span><span class="w"> </span><span class="n">agent_state</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Set Log</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">exit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExitLogFrame</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">environment_log</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">agents_log</span><span class="p">),</span><span class="w"> </span><span class="n">step_count</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Add the timing info</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">.</span><span class="n">rtc_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getElapsedTimeRTCInitialisation</span><span class="p">();</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">.</span><span class="n">init_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getElapsedTimeInitFunctions</span><span class="p">();</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">.</span><span class="n">exit_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getElapsedTimeExitFunctions</span><span class="p">();</span>
<span class="w">    </span><span class="n">run_log</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">.</span><span class="n">total_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getElapsedTimeSimulation</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">const</span><span class="w"> </span><span class="n">RunLog</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getRunLog</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="n">run_log</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">createStreams</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nStreams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// There should always be atleast 1 stream, as some tests require the 0th stream even when there is no concurrent work to be done.</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">nStreams</span><span class="p">,</span><span class="w"> </span><span class="mi">1u</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">streams</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">totalStreams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">));</span>
<span class="w">        </span><span class="n">streams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">cudaStream_t</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getStream</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Return the appropriate stream, unless concurrency is disabled in which case always stream 0.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMaximumLayerWidth</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">createStreams</span><span class="p">(</span><span class="n">nStreams</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getCUDAConfig</span><span class="p">().</span><span class="n">inLayerConcurrency</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">streams</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">streams</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">streams</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">destroyStreams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// early exit if there are no streams to reset</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">streams</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    This method is called by ~CUDASimulation(), which may be after a device reset and / or CUDA shutdown (if static, or if GC&#39;d by python implementation)</span>
<span class="cm">    cudaStreamDestroy and cudaStreamQuery under linux with CUDA 11.8 (and potentialy others) would occasionally segfault after a reset, as passing invalid stream handles to various methods is UB, so these methods cannot be used to check for safe destruction.</span>
<span class="cm">    The Driver API equivalents include the same UB.</span>
<span class="cm">    Instead, we can use the CUDA driver API to check the primary context is correct / valid for the device, and if it is attempt to destory the stream, which works for CUDA 11.x.</span>
<span class="cm">    CUDA 12.x however claims the ctx is active for the specified device, even after a reset. Getting the active context returns the same handle after a reset, so we cannot store and compare CUcontexts, but CUDA 12 does include a new method to get the unique ID for a context which we can store and check is a match.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">safeToDestroySreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">cuda</span><span class="o">::</span><span class="n">cuDevicePrimaryContextIsActive</span><span class="p">(</span><span class="n">deviceInitialised</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#if __CUDACC_VER_MAJOR__ &gt;= 12</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">currentContextID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">cuda</span><span class="o">::</span><span class="n">cuGetCurrentContextUniqueID</span><span class="p">();</span>
<span class="w">        </span><span class="n">safeToDestroySreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">safeToDestroySreams</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">currentContextID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">cudaContextID</span><span class="p">;</span>
<span class="w">    </span><span class="cp">#endif  </span><span class="c1">// __CUDACC_VER_MAJOR__ &gt;= 12</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">safeToDestroySreams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Destroy streams.</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">streams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaStreamDestroy</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">streams</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">synchronizeAllStreams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Sync streams.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">streams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gpuErrchk</span><span class="p">(</span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">EnvironmentManager</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">getEnvironment</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">singletons</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">environment</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CUDASimulation</span><span class="o">::</span><span class="n">assignAgentIDs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">flamegpu</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">nvtx</span><span class="o">::</span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">{</span><span class="s">&quot;CUDASimulation::assignAgentIDs&quot;</span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">agent_ids_have_init</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Ensure singletons have been initialised</span>
<span class="w">        </span><span class="n">initialiseSingletons</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">agent_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">assignIDs</span><span class="p">(</span><span class="o">*</span><span class="n">host_api</span><span class="p">,</span><span class="w"> </span><span class="n">singletons</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span><span class="w"> </span><span class="n">getStream</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// This could be made concurrent, 1 stream per agent</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">agent_ids_have_init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="p">}</span><span class="w">  </span><span class="c1">// namespace flamegpu</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, University of Sheffield.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-XXXXXXX-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>